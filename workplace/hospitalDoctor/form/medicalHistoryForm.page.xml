<?xml version='1.0' encoding='UTF-8'?>
<page xmlns="http://n2oapp.net/framework/config/schema/page-1.0"
      xmlns:ctrl="http://n2oapp.net/framework/config/schema/n2o-control-1.0"
      xmlns:wgt="http://n2oapp.net/framework/config/schema/n2o-widget-2.0"
      xmlns:fs2="http://n2oapp.net/framework/config/schema/fieldset-2.0">

    <object-id>medicalHistory</object-id>
    <layout>n2o/layout/top-bottom</layout>

    <regions>
        <region place="top" type="none">
            <container id="medicalHistoryContainerForm"
                       xmlns:ctrl="http://n2oapp.net/framework/config/schema/n2o-control-1.0">
                <wgt:form detail-field-id="id" master-field-id="id">
                    <wgt:query-id>medicalHistoryForm</wgt:query-id>
                    <wgt:name>История болезни</wgt:name>

                    <wgt:action-menu>
                        <wgt:menu-item id="save" label="Изменить">
                            <wgt:edit>
                                <wgt:invoke-action action-id="save"/>
                            </wgt:edit>
                        </wgt:menu-item>
                    </wgt:action-menu>

                    <wgt:edit after-submit="edit" refresh-after-submit="true">
                        <wgt:invoke-action action-id="save"/>
                    </wgt:edit>

                    <fs2:field-set>
                        <fs2:row>
                            <ctrl:output-text id="patientName" label="Пациент:" label-style="font-weight:bold;"/>
                            <ctrl:output-text id="birthDate" label="Дата рождения:" label-style="font-weight:bold;"/>
                            <ctrl:output-text id="gender" label="Пол:" label-style="font-weight:bold;"/>
                        </fs2:row>
                    </fs2:field-set>

                    <fs2:field-set header="line">

                        <fs2:row>
                            <ctrl:output-text id="uid" label="№ИБ:"/>
                            <ctrl:output-text id="financialType" label="Вид оплаты:"/>
                            <ctrl:output-text id="admissionDate" label="Дата поступления:"/>
                        </fs2:row>

                        <fs2:row>
                            <ctrl:output-text id="doctor" label="Лечащий врач:"/>

                            <ctrl:classifier id="diet_f" label="Диета:" search-as-you-type="true">
                                <ctrl:query query-id="hosp_mdDiet" value-field-id="id" label-field-id="name"/>
                                <ctrl:actions>
                                    <ctrl:button icon="icomoon-history" type="icon" label="Список назначенных диет">
                                        <ctrl:open-page model="default" master-field-id="case.id"
                                                        detail-field-id="caseId" page-id="diet">
                                            <ctrl:pre-filters>
                                                <ctrl:pre-filter field-id="case.id" ref="case.id"
                                                                 container-id="dietTable"/>
                                            </ctrl:pre-filters>
                                        </ctrl:open-page>
                                    </ctrl:button>
                                </ctrl:actions>
                            </ctrl:classifier>
                            <ctrl:date-time id="issuePlannedDate" format="DD.MM.YYYY" control-style="width:150px;"
                                            label="Дата по плану:">
                                <ctrl:actions>
                                    <ctrl:link label="Заполнить">
                                        <ctrl:on-click src="hospital/n2o/custom/medicalHistoryForm"
                                                       function-name="fill"/>
                                    </ctrl:link>
                                </ctrl:actions>
                            </ctrl:date-time>
                        </fs2:row>

                        <fs2:row>
                            <ctrl:output-text id="department" label="Отделение:"/>

                            <ctrl:classifier id="provisionCondition" label="Режим лечения:" search-as-you-type="true">
                                <ctrl:query query-id="hosp_provisionCondition" value-field-id="id"
                                            label-field-id="name"/>
                            </ctrl:classifier>

                            <ctrl:output-text id="outcomeDate" label="Дата по факту:"/>
                        </fs2:row>

                        <fs2:row>
                            <ctrl:output-text id="bedDaysAmount" label="Количество к/д:"/>
                        </fs2:row>

                    </fs2:field-set>

                    <fs2:field-set header="line">

                        <fs2:row>
                            <ctrl:output-text id="diagnosisName" label="Основной диагноз:"
                                              control-style="width:1000px;"/>
                        </fs2:row>

                        <fs2:row>
                            <ctrl:output-text id="standard" label="Стандарт:" control-style="width:1000px;"/>
                        </fs2:row>

                    </fs2:field-set>

                </wgt:form>

            </container>
        </region>

        <region place="bottom" type="pills">
            <container id="diagnosisList" depends-on="medicalHistoryContainerForm" refresh-dependent-container="true">
                <wgt:table detail-field-id="case.id" master-field-id="case.id">
                    <wgt:name>Диагнозы</wgt:name>
                    <wgt:query-id>mdHistoryForm_diagnosisList</wgt:query-id>
                    <wgt:size>10</wgt:size>

                    <wgt:action-menu>

                        <wgt:menu-item label="Добавить" context="false" id="create">
                            <wgt:show-modal page-id="mdHistoryForm_diagnosisForm"
                                            width="width:50%;min-width:350px;max-width:600px;"
                                            container-id="diagnosisForm" action-id="save" refresh-on-close="true"
                                            master-field-id="id" detail-field-id="id">
                            </wgt:show-modal>
                        </wgt:menu-item>

                        <wgt:menu-item label="Изменить" context="true" id="update">
                            <wgt:show-modal page-id="mdHistoryForm_diagnosisForm"
                                            width="width:50%;min-width:350px;max-width:600px;" master-field-id="id"
                                            detail-field-id="id" action-id="save" container-id="diagnosisForm"
                                            refresh-on-close="true"/>
                        </wgt:menu-item>

                        <wgt:menu-item label="Удалить" id="delete" context="true">
                            <wgt:invoke-action action-id="delete" confirmation="true"/>
                        </wgt:menu-item>

                        <wgt:menu-item label="Получить из протоколов" id="getFromProtocol" context="false">
                            <wgt:invoke-action action-id="copyFromProtocol" confirmation="false"/>
                        </wgt:menu-item>

                    </wgt:action-menu>

                    <wgt:columns>
                        <wgt:column column-field-id="stage.name" width="20%"/>
                        <wgt:column column-field-id="type.name" width="10%"/>
                        <wgt:column column-field-id="diagnosis" width="60%"/>
                        <wgt:column column-field-id="date" width="10%"/>
                    </wgt:columns>

                    <wgt:filters position="top">
                        <ctrl:classifier id="department" label="Отделение" search-as-you-type="true">
                            <ctrl:query query-id="hosp_departmentByCase" value-field-id="id" label-field-id="name">
                                <ctrl:pre-filters>
                                    <ctrl:pre-filter field-id="caseId" ref="case.id"/>
                                </ctrl:pre-filters>
                            </ctrl:query>
                        </ctrl:classifier>

                    </wgt:filters>

                </wgt:table>

                <pre-filters>
                    <pre-filter field-id="case.id" ref="case.id"/>
                </pre-filters>

                <!--<counter/>-->

            </container>

            <container id="physicalServices" depends-on="medicalHistoryContainerForm"
                       refresh-dependent-container="true">
                <wgt:table detail-field-id="case.id" master-field-id="case.id">
                    <wgt:name>Осмотры</wgt:name>
                    <wgt:query-id>mdHistoryForm_physicalService</wgt:query-id>
                    <wgt:size>15</wgt:size>

                    <wgt:action-menu>

                        <wgt:menu-item label="Добавить" context="false" id="create">
                            <wgt:open-page page-id="srvRenderedProtocol"
                                           width="50%"
                                           refresh-on-close="true"/>
                        </wgt:menu-item>

                        <wgt:menu-item label="Копировать" context="true" id="copy">
                            <wgt:open-page page-id="srvRenderedProtocolCopy"
                                           container-id="main"
                                           width="50%"
                                           refresh-on-close="true"
                                           master-field-id="id"
                                           detail-field-id="id"
                            />
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>protocolId != null</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="createRendered" context="true" label="Внести результат">
                            <wgt:open-page page-id="renderedService"
                                           master-field-id="id" detail-field-id="id"
                                           width="800px;" refresh-on-close="true"
                                           model="default"
                                           action-id="createRenderedService"
                                           after-submit="edit">
                            </wgt:open-page>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isRendered == false &amp;&amp; protocolId == null</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="editRendered" context="true" label="Внести результат">
                            <wgt:open-page page-id="renderedService"
                                           model="query"
                                           action-id="updateRenderedService"
                                           after-submit="edit"
                                           master-field-id="id" detail-field-id="id"
                                           width="800px;" refresh-on-close="true">
                            </wgt:open-page>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isRendered == true &amp;&amp; protocolId == null</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="renderedWithProtocol" context="true" label="Изменить результат">
                            <wgt:open-page page-id="renderedService"
                                           model="query"
                                           action-id="updateRenderedService"
                                           after-submit="edit"
                                           master-field-id="id" detail-field-id="id"
                                           width="800px;" refresh-on-close="true"
                                           page-name="Изменить результат">
                            </wgt:open-page>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>protocolId != null</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Отменить результат" id="cancelRendered" context="true">
                            <wgt:invoke-action action-id="cancelRendered" confirmation="true"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isRendered == true</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Удалить" id="delete" context="true">
                            <wgt:invoke-action action-id="delete" confirmation="true"/>
                            <wgt:invoke-action action-id="delete" confirmation="true"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isRendered == true &amp;&amp; isCreateByAppointment != true
                                    </wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Удалить" id="deletePlannedService" context="true">
                            <wgt:invoke-action action-id="deletePlannedService" confirmation="true"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isPlannedServiceWithoutAppointment == true</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Печать" id="print" context="true" icon="icomoon-printer">
                            <wgt:a href="${rmis.report.birt.url}/run?__report=protocol/:printForm|s:&amp;p=:protocolId:&amp;user_id=:user.id:&amp;__format=pdf"
                                   target="newWindow"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>protocolId != null</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="appointmentCancelReason" context="true" label="Отмена">
                            <wgt:show-modal-form form-id="appointmentCancelReason" refresh-on-close="true"
                                                 master-field-id="id" detail-field-id="id">

                                <wgt:edit model="default">
                                    <wgt:invoke-action action-id="appointmentCancelReason"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isCancelAppointment == true</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>


                    </wgt:action-menu>

                    <wgt:columns>
                        <wgt:column column-field-id="hospRecord"/>
                        <wgt:column column-field-id="service"/>
                        <wgt:column column-field-id="renderedDoctor"/>
                        <wgt:column column-field-id="status"/>
                        <wgt:column column-field-id="renderedDate" format="date 'DD.MM.YYYY HH:mm'"/>
                    </wgt:columns>

                    <wgt:filters>
                        <ctrl:classifier id="department" label="Отделение" search-as-you-type="true">
                            <ctrl:query query-id="hosp_departmentByCase" value-field-id="id" label-field-id="name">
                                <ctrl:pre-filters>
                                    <ctrl:pre-filter field-id="caseId" ref="case.id"/>
                                </ctrl:pre-filters>
                            </ctrl:query>
                        </ctrl:classifier>
                    </wgt:filters>

                    <wgt:sortings>
                        <wgt:sorting sorting-field-id="renderedDate" direction="ASC"/>
                    </wgt:sortings>
                </wgt:table>

                <pre-filters>
                    <pre-filter field-id="case.id" ref="case.id"/>
                </pre-filters>

                <!--<counter/>-->
            </container>

            <container id="prescriptionList" depends-on="medicalHistoryContainerForm"
                       refresh-dependent-container="true">
                <wgt:table ref-id="hosp_prescription_list" detail-field-id="case.id" master-field-id="case.id"/>
                <pre-filters>
                    <pre-filter field-id="case.id" ref="case.id"/>
                </pre-filters>
            </container>

            <container id="prescriptionServiceList" depends-on="medicalHistoryContainerForm">
                <wgt:table detail-field-id="case.id" master-field-id="case.id"
                           customize="jsp" src="hospital/n2o/custom/prescription/service/prescriptionServiceList">
                    <wgt:query-id>prescriptionServiceList</wgt:query-id>
                    <wgt:name>Процедуры</wgt:name>
                    <wgt:size>10</wgt:size>

                    <wgt:action-menu>
                        <wgt:menu-item label="Добавить" context="false" id="create">
                            <wgt:show-modal-form
                                    form-id="hosp_prescriptionServiceForm"
                                    width="660px;"
                                    refresh-on-close="true">
                                <wgt:edit after-submit="closeModal" refresh-after-submit="true">
                                    <wgt:invoke-action action-id="save"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                        </wgt:menu-item>

                        <wgt:menu-item label="Изменить" context="true" id="update">
                            <wgt:show-modal-form
                                    form-id="hosp_prescriptionServiceForm"
                                    width="660px;"
                                    master-field-id="id" detail-field-id="id"
                                    refresh-on-close="true">
                                <wgt:edit after-submit="closeModal" refresh-after-submit="true">
                                    <wgt:invoke-action action-id="save"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>hasRenderedServices == false</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Подтвердить" id="confirm" context="true">
                            <wgt:invoke-action action-id="confirm" confirmation="false"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>statusId == 1 &amp;&amp; serviceId != null</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Отменить" context="true" id="cancel" icon="icomoon-cancel-circle">
                            <wgt:show-modal-form
                                    form-id="hosp_prescriptionServiceCancel"
                                    refresh-on-close="true"
                                    width="600px;"
                                    master-field-id="prescriptionId" detail-field-id="prescriptionId">
                                <wgt:edit model="default">
                                    <wgt:invoke-action action-id="cancel"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>statusId == 3</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Удалить" context="true" id="delete">
                            <wgt:invoke-action action-id="delete" confirmation="true"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>hasRenderedServices == false</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                    </wgt:action-menu>

                    <wgt:filters>
                        <ctrl:classifier id="department" label="Отделение" search-as-you-type="true">
                            <ctrl:query query-id="hosp_departmentByCase" value-field-id="id" label-field-id="name">
                                <ctrl:pre-filters>
                                    <ctrl:pre-filter field-id="caseId" ref="case.id"/>
                                </ctrl:pre-filters>
                            </ctrl:query>
                        </ctrl:classifier>

                        <ctrl:checkbox id="all" label="Все назначения"/>
                    </wgt:filters>

                    <wgt:rows>
                        <wgt:color color-field-id="statusColor"/>
                    </wgt:rows>

                    <wgt:columns>
                        <wgt:column column-field-id="name"/>
                        <wgt:column column-field-id="periodBeginDt"/>
                        <wgt:column column-field-id="periodEndDt"/>
                        <wgt:column column-field-id="count"/>
                        <wgt:column column-field-id="periodicity"/>
                        <wgt:column column-field-id="visitTerm"/>
                        <wgt:column column-field-id="status"/>
                        <wgt:column column-field-id="doctor"/>
                    </wgt:columns>
                </wgt:table>
            </container>


            <container id="plannedAndRenderedServiceList" depends-on="medicalHistoryContainerForm"
                       refresh-dependent-container="true">
                <wgt:table detail-field-id="case.id" master-field-id="case.id">
                    <wgt:name>Направления на услуги</wgt:name>
                    <wgt:query-id>plannedAndRenderedServiceList</wgt:query-id>
                    <wgt:size>15</wgt:size>

                    <wgt:action-menu>
                        <wgt:menu-item label="Добавить" context="false" id="add">
                            <wgt:sub-menu>
                                <wgt:menu-item id="assign" context="false" label="Назначить">
                                    <wgt:show-modal-form form-id="plannedServiceForm"
                                                         width="width:50%;min-width:350px;max-width:700px;"
                                                         refresh-on-close="true"
                                                         master-field-id="id" detail-field-id="id">

                                        <wgt:edit model="default">
                                            <wgt:invoke-action action-id="savePlannedService"/>
                                        </wgt:edit>
                                    </wgt:show-modal-form>
                                </wgt:menu-item>

                                <wgt:menu-item id="srvByTemplate" context="false" label="По шаблону">
                                    <wgt:show-modal-form form-id="serviceByTemplate"
                                                         width="width:50%;min-width:350px;max-width:700px;"
                                                         refresh-on-close="true"
                                                         master-field-id="case.id" detail-field-id="case.id">
                                        <wgt:edit model="default">

                                        </wgt:edit>
                                    </wgt:show-modal-form>
                                </wgt:menu-item>

                                <wgt:menu-item label="В расписание" id="planning" context="false">
                                    <wgt:a href="${rmis.external.host}/plan/planning?organizationId=:case.organization.id:&amp;value=:case.patient.id:&amp;fundingSourceType.id=:case.fundingSourceType.id:&amp;caseId=:case.id:&amp;stepId=:case.step.id:"
                                           target="newWindow"/>
                                </wgt:menu-item>

                                <wgt:menu-item id="createPlannedOperation" context="false" label="Операцию">
                                    <wgt:show-modal-form form-id="plannedOperation"
                                                         width="width:90%;min-width:350px;max-width:700px;"
                                                         refresh-on-close="true"
                                                         master-field-id="id" detail-field-id="id">

                                        <wgt:edit model="default">
                                            <wgt:invoke-action action-id="saveWaitConfirmationOperation"/>
                                        </wgt:edit>
                                    </wgt:show-modal-form>
                                </wgt:menu-item>
                            </wgt:sub-menu>
                        </wgt:menu-item>

                        <wgt:menu-item id="update" context="true" label="Изменить">
                            <wgt:show-modal-form form-id="plannedServiceForm"
                                                 width="width:50%;min-width:350px;max-width:700px;"
                                                 refresh-on-close="true"
                                                 master-field-id="id" detail-field-id="id">
                                <wgt:edit model="query">
                                    <wgt:invoke-action action-id="savePlannedService"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isPlannedServiceWithoutAppointment == true &amp;&amp; isOperation !=
                                        true
                                    </wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="updatePlannedOperation" context="true" label="Изменить" icon="icon-pencil">
                            <wgt:show-modal-form form-id="plannedOperation"
                                                 width="width:90%;min-width:350px;max-width:700px;"
                                                 refresh-on-close="true"
                                                 master-field-id="id" detail-field-id="id">

                                <wgt:edit model="query" refresh-after-submit="true">
                                    <wgt:invoke-action action-id="saveWaitConfirmationOperation"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isOperation == true &amp;&amp; isPlannedServiceWithoutAppointment ==
                                        true
                                    </wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="createRendered" context="true" label="Внести результат">
                            <wgt:open-page page-id="renderedService"
                                           master-field-id="id" detail-field-id="id"
                                           model="default"
                                           action-id="createRenderedService"
                                           after-submit="edit"
                                           refresh-after-submit="true"
                                           width="800px;" refresh-on-close="true">
                            </wgt:open-page>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>
                                        <![CDATA[ !isOperation && !isRendered && protocolId == null && !isPregnant ]]> </wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="createRenderOperation" context="true" label="Внести результат">
                            <wgt:open-page page-id="renderedOperation" model="default"
                                           action-id="renderOperation"
                                           after-submit="edit"
                                           master-field-id="id" detail-field-id="id" refresh-on-close="true">
                            </wgt:open-page>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>
                                        <![CDATA[ isOperation && !isRendered && protocolId == null && !isPregnant ]]>
                                    </wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="createPregnantOperation" label="Внести результат">
                            <wgt:open-page page-id="pregnantOperation" refresh-on-close="true" action-id="save"
                                           after-submit="edit" refresh-after-submit="true" master-field-id="id"
                                           detail-field-id="id" model="default"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression><![CDATA[ isOperation && isPregnant && protocolId == null && !isRendered ]]></wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="editRendered" context="true" label="Внести результат">
                            <wgt:open-page page-id="renderedService"
                                           model="query"
                                           after-submit="edit"
                                           action-id="updateRenderedService"
                                           master-field-id="id" detail-field-id="id"
                                           width="800px;" refresh-on-close="true">
                            </wgt:open-page>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>
                                        <![CDATA[ !isOperation && isRendered && protocolId == null && !isPregnant ]]></wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="editRenderedOperation" context="true" label="Внести результат">
                            <wgt:open-page page-id="renderedOperation" model="default"
                                           action-id="renderOperation"
                                           after-submit="edit"
                                           master-field-id="id" detail-field-id="id"
                                           refresh-on-close="true">
                            </wgt:open-page>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>
                                        <![CDATA[ isOperation && isRendered && protocolId == null && !isPregnant ]]>
                                    </wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="notRenderedWithProtocol" context="true" label="Изменить результат">
                            <wgt:open-page page-id="renderedService"
                                           model="default"
                                           after-submit="edit"
                                           action-id="updateRenderedService"
                                           master-field-id="id" detail-field-id="id"
                                           width="800px;" refresh-on-close="true"
                                           page-name="Изменить результат">
                            </wgt:open-page>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>
                                        <![CDATA[ !isOperation && protocolId != null && !isPregnant && !isRendered]]></wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="renderedWithProtocol" context="true" label="Изменить результат">
                            <wgt:open-page page-id="renderedService"
                                           model="query"
                                           after-submit="edit"
                                           action-id="updateRenderedService"
                                           master-field-id="id" detail-field-id="id"
                                           width="800px;" refresh-on-close="true"
                                           page-name="Изменить результат">
                            </wgt:open-page>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>
                                        <![CDATA[ !isOperation && protocolId != null && !isPregnant && isRendered]]></wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>


                        <wgt:menu-item id="notRenderedOperationWithProtocol" context="true" label="Изменить результат">
                            <wgt:open-page page-id="renderedOperation" model="default"
                                           action-id="renderOperation"
                                           master-field-id="id" detail-field-id="id"
                                           refresh-on-close="true"
                                           after-submit="edit"
                                           page-name="Изменить результат">
                            </wgt:open-page>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>
                                        <![CDATA[ isOperation && protocolId != null && !isPregnant && !isRendered]]></wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="renderedOperationWithProtocol" context="true" label="Изменить результат">
                            <wgt:open-page page-id="renderedOperation" model="query"
                                           action-id="renderOperation"
                                           master-field-id="id" detail-field-id="id"
                                           refresh-on-close="true"
                                           after-submit="edit"
                                           page-name="Изменить результат">
                            </wgt:open-page>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>
                                        <![CDATA[ isOperation && protocolId != null && !isPregnant && isRendered]]></wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="editPregnantOperation" label="Изменить результат">
                            <wgt:open-page page-id="pregnantOperation" refresh-on-close="true" action-id="save"
                                           after-submit="edit" refresh-after-submit="true" master-field-id="id"
                                           detail-field-id="id" model="query"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression><![CDATA[ isOperation && isPregnant && isRendered ]]></wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Отменить результат" id="cancelRendered" context="true">
                            <wgt:invoke-action action-id="cancelRendered" confirmation="true"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isRendered == true</wgt:expression>
                                </wgt:visibility-condition>
                                <wgt:enabling-condition>
                                    <wgt:expression>
                                        <![CDATA[ !hasChildOrPartogram ]]>
                                    </wgt:expression>
                                    <wgt:tooltip>Нельзя отменить услугу, на которую ссылаются созданные новорожденные или параметры партограммы.</wgt:tooltip>
                                </wgt:enabling-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="partograph" label="Партограмма" icon="icomoon-stats-bars" type="textAndIcon">
                            <wgt:open-page page-id="pregnantService" action-id="save"
                                           model="query-or-default" after-submit="edit" refresh-after-submit="true"
                                           master-field-id="id" detail-field-id="id" refresh-on-close="true"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression><![CDATA[ !isOperation && isPregnant ]]></wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Удалить" id="delete" context="true">
                            <wgt:invoke-action action-id="delete" confirmation="true"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isRendered == true &amp;&amp; isCreateByAppointment != true
                                    </wgt:expression>
                                </wgt:visibility-condition>
                                <wgt:enabling-condition>
                                    <wgt:expression>
                                        <![CDATA[ !hasChildOrPartogram ]]>
                                    </wgt:expression>
                                    <wgt:tooltip>Нельзя удалить услугу, на которую ссылаются созданные новорожденные или параметры партограммы.</wgt:tooltip>
                                </wgt:enabling-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Удалить" id="deletePlannedService" context="true">
                            <wgt:invoke-action action-id="deletePlannedService" confirmation="true"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isPlannedServiceWithoutAppointment == true</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Печать" id="print" context="true" icon="icomoon-printer">
                            <wgt:a href="${rmis.report.birt.url}/run?__report=protocol/:printForm|s:&amp;p=:protocolId:&amp;user_id=:user.id:&amp;__format=pdf"
                                   target="newWindow"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>protocolId != null</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="appointmentCancelReason" context="true" label="Отмена">
                            <wgt:show-modal-form form-id="appointmentCancelReason" refresh-on-close="true"
                                                 master-field-id="appointmentId" detail-field-id="appointmentId">

                                <wgt:edit model="default">
                                    <wgt:invoke-action action-id="appointmentCancelReason"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isCancelAppointment == true</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                    </wgt:action-menu>


                    <wgt:columns>
                        <wgt:column column-field-id="byStandard" name="По стандарту">
                            <wgt:icon>
                                <wgt:switch>
                                    <wgt:case value="true">icon-star</wgt:case>
                                </wgt:switch>
                            </wgt:icon>
                        </wgt:column>
                        <wgt:column column-field-id="name"/>
                        <wgt:column column-field-id="plannedDate" format="date 'DD.MM.YYYY HH:mm'"/>
                        <wgt:column column-field-id="renderedDate" format="date 'DD.MM.YYYY HH:mm'"/>
                        <wgt:column column-field-id="status"/>
                        <wgt:column column-field-id="doctor"/>
                        <wgt:column column-field-id="department"/>
                    </wgt:columns>

                    <wgt:filters>
                        <!--<ctrl:output-text id="case.id"/>-->
                        <!--<ctrl:output-text id="case.step.id"/>-->
                        <!--<ctrl:output-text id="case.patient.id"/>-->
                        <!--<ctrl:output-text id="case.fundingSourceType.id"/>-->
                        <!--<ctrl:output-text id="case.organization.id"/>-->

                        <ctrl:classifier id="stepDepartment" label="Отделение" search-as-you-type="true">
                            <ctrl:query query-id="hosp_departmentByCase" value-field-id="id" label-field-id="name">
                                <ctrl:pre-filters>
                                    <ctrl:pre-filter field-id="caseId" ref="case.id"/>
                                </ctrl:pre-filters>
                            </ctrl:query>
                        </ctrl:classifier>

                        <ctrl:checkbox id="createdByPrescription" label="Отображать процедуры"/>

                    </wgt:filters>

                    <wgt:sortings>
                        <wgt:sorting sorting-field-id="plannedDate" direction="ASC"/>
                    </wgt:sortings>
                </wgt:table>

                <pre-filters>
                    <pre-filter field-id="case.organization.id" ref="case.organization.id"/>
                    <pre-filter field-id="case.patient.id" ref="case.patient.id"/>
                    <pre-filter field-id="case.fundingSourceType.id" ref="case.fundingSourceType.id"/>
                    <pre-filter field-id="case.step.id" ref="case.step.id"/>
                    <pre-filter field-id="case.id" ref="case.id"/>
                </pre-filters>

                <!--<counter/>-->

            </container>

            <container id="hospitalRecordList" depends-on="medicalHistoryContainerForm"
                       refresh-dependent-container="true">

                <wgt:table detail-field-id="caseId" master-field-id="case.id">
                    <wgt:action-menu>
                        <wgt:menu-item label="Добавить" context="false" id="create">
                            <wgt:show-modal-form width="1000px;" form-id="movePatient_form">
                                <wgt:pre-filters>
                                    <wgt:pre-filter field-id="caseId" ref="caseId"/>
                                    <wgt:pre-filter field-id="create" value="true"/>
                                </wgt:pre-filters>
                                <wgt:edit>
                                    <wgt:invoke-action action-id="create"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                        </wgt:menu-item>

                        <wgt:menu-item label="Изменить" context="true" id="update">
                            <wgt:show-modal-form width="1000px" master-field-id="id" detail-field-id="id"
                                                 form-id="movePatient_form">
                                <wgt:edit model="query">
                                    <wgt:invoke-action action-id="update"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                        </wgt:menu-item>

                        <wgt:menu-item label="Удалить" id="delete" context="true">
                            <wgt:invoke-action action-id="delete" confirmation="true"/>
                            <wgt:conditions>
                                <wgt:enabling-condition>
                                    <wgt:expression>(lastHospitalRecordId == id)</wgt:expression>
                                </wgt:enabling-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Выписать" id="discharge" context="true" icon="icomoon-exit">
                            <wgt:show-modal-form width="1000px;" form-id="discharge"
                                                 page-name="Выписать из стационара - {medicalHistoryContainerForm.uidForTitle} {medicalHistoryContainerForm.patient.name}"
                                                 master-field-id="lastHospitalRecordId" detail-field-id="id">
                                <wgt:edit model="default" refresh-after-submit="true">
                                    <wgt:invoke-action action-id="discharge"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isClosed == false</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Редактировать выписку" context="true" id="editDischarge"
                                       icon="icomoon-enter">

                            <wgt:show-modal-form width="1000px;" form-id="discharge"
                                                 page-name="Выписать из стационара - {medicalHistoryContainerForm.uidForTitle} {medicalHistoryContainerForm.patient.name}"
                                                 master-field-id="lastHospitalRecordId" detail-field-id="id">
                                <wgt:edit model="query" after-submit="edit" refresh-after-submit="true">
                                    <wgt:invoke-action action-id="discharge"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isClosed == true</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Отмена выписки" context="true" id="reopen" icon="icomoon-cross">
                            <wgt:invoke-action action-id="reopen" confirmation="true"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>isClosed == true</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                    </wgt:action-menu>

                    <wgt:name>Движение по отделениям</wgt:name>
                    <wgt:query-id>movePatient_list</wgt:query-id>
                    <wgt:size>15</wgt:size>
                    <wgt:columns>
                        <wgt:column column-field-id="admissionDate" format="date 'DD.MM.YYYY HH:mm'"/>
                        <wgt:column column-field-id="outcomeDate" format="date 'DD.MM.YYYY HH:mm'"/>
                        <wgt:column column-field-id="department"/>
                        <wgt:column column-field-id="result"/>
                        <wgt:column column-field-id="outcome"/>
                    </wgt:columns>

                    <wgt:sortings>
                        <wgt:sorting sorting-field-id="admissionDate" direction="ASC"/>
                    </wgt:sortings>
                </wgt:table>

            </container>

            <container id="bedList" depends-on="medicalHistoryContainerForm"
                       refresh-dependent-container="true">
                <wgt:table detail-field-id="case.id" master-field-id="case.id">
                    <wgt:name>Движение по койкам</wgt:name>
                    <wgt:query-id>hospHistory_bedList</wgt:query-id>
                    <wgt:size>15</wgt:size>

                    <wgt:filters>
                        <ctrl:classifier id="department" label="Отделение" search-as-you-type="true">
                            <ctrl:query query-id="hosp_departmentByCase" value-field-id="id" label-field-id="name">
                                <ctrl:pre-filters>
                                    <ctrl:pre-filter field-id="caseId" ref="case.id"/>
                                </ctrl:pre-filters>
                            </ctrl:query>
                        </ctrl:classifier>
                    </wgt:filters>

                    <wgt:action-menu>

                        <wgt:menu-item label="Добавить" context="false" id="create">
                            <wgt:show-modal-form width="50%" form-id="nurse_bed_form" master-field-id="id"
                                                 detail-field-id="id">
                                <wgt:edit model="default">
                                    <wgt:invoke-action action-id="save"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                        </wgt:menu-item>

                        <wgt:menu-item label="Изменить" context="true" id="update">
                            <wgt:show-modal-form width="50%" form-id="nurse_bed_form" master-field-id="id"
                                                 detail-field-id="id">
                                <wgt:edit model="query">
                                    <wgt:invoke-action action-id="save"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                        </wgt:menu-item>

                        <wgt:menu-item label="Удалить" id="delete" context="true">
                            <wgt:invoke-action action-id="delete" confirmation="true"/>
                        </wgt:menu-item>

                    </wgt:action-menu>

                    <wgt:columns>
                        <wgt:column column-field-id="hospRecord"/>
                        <wgt:column column-field-id="beginDate" format="date 'DD.MM.YYYY HH:mm'"/>
                        <wgt:column column-field-id="endDate" format="date 'DD.MM.YYYY HH:mm'"/>
                        <wgt:column column-field-id="room"/>
                        <wgt:column column-field-id="bed"/>
                    </wgt:columns>
                    <wgt:sortings>
                        <wgt:sorting sorting-field-id="beginDate" direction="ASC"/>
                    </wgt:sortings>
                </wgt:table>

                <pre-filters>
                    <pre-filter field-id="case.id" ref="case.id"/>
                    <pre-filter field-id="case.step.id" ref="case.step.id"/>
                </pre-filters>
            </container>

            <container id="otherHospitalCase" depends-on="medicalHistoryContainerForm"
                       refresh-dependent-container="true">
                <wgt:table detail-field-id="caseId" master-field-id="case.id">
                    <wgt:query-id>hospHistory_otherHospitalCase</wgt:query-id>
                    <wgt:size>20</wgt:size>
                    <wgt:name>Предыдущие госпитализации</wgt:name>

                    <wgt:columns>
                        <wgt:column column-field-id="uid"/>
                        <wgt:column column-field-id="openDate"/>
                        <wgt:column column-field-id="outcomeDate"/>
                        <wgt:column column-field-id="diagnosis"/>
                        <wgt:column column-field-id="result"/>
                        <wgt:column column-field-id="outcome"/>
                    </wgt:columns>

                    <wgt:action-menu>

                        <wgt:menu-item label="Просмотр" context="true" id="view">
                            <wgt:open-page page-id="medicalHistoryFormView"
                                           master-field-id="caseId" detail-field-id="caseId"
                                           page-name="Предыдущая госпитализация {otherHospitalCase.uidForTitle}">
                                <wgt:pre-filters>
                                    <wgt:pre-filter field-id="view" value="true"/>
                                </wgt:pre-filters>
                            </wgt:open-page>
                        </wgt:menu-item>

                    </wgt:action-menu>

                    <wgt:sortings>
                        <wgt:sorting sorting-field-id="openDate" direction="ASC"/>
                    </wgt:sortings>

                </wgt:table>

                <pre-filters>
                    <pre-filter field-id="organizationId" value="#{org.id?}"/>
                    <pre-filter field-id="user_id" value="#{user.id?}"/>
                </pre-filters>

            </container>

            <container id="hospitalizationInfo" depends-on="medicalHistoryContainerForm">
                <wgt:form src="hospital/n2o/custom/markMsgStyle" customize="css" detail-field-id="case.id"
                          master-field-id="case.id">
                    <wgt:name>Информация о госпитализации</wgt:name>
                    <wgt:query-id>hospitalizationInfo</wgt:query-id>

                    <wgt:edit after-submit="edit" model="query" refresh-after-submit="true">
                        <wgt:invoke-action action-id="save"/>
                    </wgt:edit>

                    <fs2:field-set field-label-location="left">
                        <fs2:row>
                            <ctrl:classifier id="careProvidingForm" label="Тип госпитализации"
                                             search-as-you-type="true" required="true">
                                <ctrl:query query-id="hosp_careProvidingForm" value-field-id="id"
                                            label-field-id="name"/>
                            </ctrl:classifier>

                            <ctrl:classifier id="initGoal" label="Причина госпитализации" required="true"
                                             search-as-you-type="true">
                                <ctrl:query query-id="hosp_initGoalByHospitalCase" value-field-id="id"
                                            label-field-id="name"/>
                            </ctrl:classifier>
                        </fs2:row>

                        <fs2:row>
                            <ctrl:classifier id="hspCanal" label="Кем доставлен" search-as-you-type="true"
                                             dependency-condition="careProvidingForm.id == 1">
                                <ctrl:query query-id="hosp_hspCanal" value-field-id="id" label-field-id="name"/>
                                <ctrl:set-value-expression>if(careProvidingForm == null || careProvidingForm.id != 1)
                                    null; else throw '!';
                                </ctrl:set-value-expression>
                            </ctrl:classifier>

                            <ctrl:input-text id="whoDeliveredCode" label="Код"
                                             dependency-condition="careProvidingForm.id == 1">
                                <ctrl:set-value-expression>if(careProvidingForm == null || careProvidingForm.id != 1)
                                    null; else throw '!';
                                </ctrl:set-value-expression>
                            </ctrl:input-text>
                            <ctrl:input-text id="whoDeliveredTeamNumber" label="Номер наряда"
                                             dependency-condition="careProvidingForm.id == 1">
                                <ctrl:set-value-expression>if(careProvidingForm == null || careProvidingForm.id != 1)
                                    null; else throw '!';
                                </ctrl:set-value-expression>
                            </ctrl:input-text>
                        </fs2:row>

                        <fs2:row>
                            <ctrl:classifier id="drunkennessType" label="Состояние опьянения"
                                             search-as-you-type="true"
                                             dependency-condition="careProvidingForm.id == 1">
                                <ctrl:query query-id="hosp_drunkennessType" value-field-id="id" label-field-id="name"/>
                                <ctrl:set-value-expression>if(careProvidingForm == null || careProvidingForm.id != 1)
                                    null; else throw '!';
                                </ctrl:set-value-expression>
                            </ctrl:classifier>

                            <ctrl:input-text id="narcoticSubstance" label="Наркотическое вещество"
                                             dependency-condition="typeof drunkennessType != 'undefined' &amp;&amp; drunkennessType != null &amp;&amp; drunkennessType.id == 2">
                                <ctrl:set-value-expression>if(drunkennessType == null || drunkennessType.id != 2) null;
                                    else throw '!';
                                </ctrl:set-value-expression>
                            </ctrl:input-text>

                            <ctrl:input-text id="whereFromDelivered" label="Откуда доставлен"
                                             dependency-condition="typeof drunkennessType != 'undefined' &amp;&amp; drunkennessType != null &amp;&amp; drunkennessType.id == 2">
                                <ctrl:set-value-expression>if(drunkennessType == null || drunkennessType.id != 2) null;
                                    else throw '!';
                                </ctrl:set-value-expression>
                            </ctrl:input-text>
                        </fs2:row>

                        <fs2:row>
                            <ctrl:classifier id="transportingType" label="Вид транспортировки"
                                             search-as-you-type="true" required="true">
                                <ctrl:query query-id="hosp_transportingType" value-field-id="id" label-field-id="name"/>
                            </ctrl:classifier>

                            <ctrl:classifier id="repeatCount" label="Кратность"
                                             search-as-you-type="true" required="true">
                                <ctrl:query query-id="hosp_repeatCount" value-field-id="id" label-field-id="name"/>
                            </ctrl:classifier>

                            <ctrl:classifier id="timeGone" label="Кол-во часов"
                                             search-as-you-type="true"
                                             dependency-condition="careProvidingForm.id == 1">
                                <ctrl:query query-id="hosp_timeGone" value-field-id="id" label-field-id="name"/>
                                <ctrl:set-value-expression>if(careProvidingForm == null || careProvidingForm.id != 1)
                                    null; else throw '!';
                                </ctrl:set-value-expression>
                            </ctrl:classifier>
                        </fs2:row>

                        <fs2:row>
                            <ctrl:classifier id="admissionReason" label="Вид травмы" search-as-you-type="true">
                                <ctrl:query query-id="hosp_admissionReason" value-field-id="id" label-field-id="name"/>
                            </ctrl:classifier>


                            <ctrl:classifier id="doctor" label="Врач" search-as-you-type="true"
                                             required="true">
                                <ctrl:query query-id="hosp_resourceEmployeePositionResource" value-field-id="id"
                                            label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="organizationId" ref="clinicId"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                            </ctrl:classifier>
                        </fs2:row>

                        <fs2:row>
                            <ctrl:classifier id="attendantIndiv" label="Сопровождающее лицо" search-as-you-type="true">
                                <ctrl:query query-id="hosp_indivWithRelation" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="patientId" ref="patientId"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>

                                <ctrl:update-model query-id="hosp_indivWithRelation" master-field-id="attendantIndiv.id"
                                                   detail-field-id="id"/>

                                <ctrl:actions>
                                    <ctrl:link label="Добавить">
                                        <ctrl:show-modal page-id="individualRelation" width="35%"
                                                         detail-field-id="patientId" master-field-id="patientId"
                                                         page-name="Добавление родственника"
                                                         result-container-id="individualRelationContainer"
                                                         action-id="save"
                                                         model="default"
                                        />
                                    </ctrl:link>
                                </ctrl:actions>

                            </ctrl:classifier>
                        </fs2:row>

                        <fs2:row css-class="mark">
                            <ctrl:hidden id="mark">
                                <ctrl:set-value-expression>
                                    if(markMsg == true) {
                                    var value = 0;
                                    if(relatives == true) {
                                    value += 1;
                                    }
                                    if( institution == true) {
                                    value += 2;
                                    }
                                    }
                                    value == 0 ? null : value;
                                </ctrl:set-value-expression>
                            </ctrl:hidden>
                            <ctrl:checkbox css-class="markMsg" id="markMsg" label="Отметка о сообщении">
                                <ctrl:set-value if="(typeof mark != 'undefined' &amp;&amp; mark != null)" then="true"/>
                            </ctrl:checkbox>
                            <ctrl:checkbox css-class="relatives" id="relatives" label="Родственникам"
                                           dependency-condition="(typeof markMsg != 'undefined' &amp;&amp; markMsg == true)">
                                <ctrl:set-value if="mark == 1 || mark == 3" then="true" else="false"/>
                            </ctrl:checkbox>
                            <ctrl:checkbox css-class="institution" id="institution" label="Учреждению"
                                           dependency-condition="(typeof markMsg != 'undefined' &amp;&amp; markMsg == true)">
                                <ctrl:set-value if="mark == 2 || mark == 3" then="true" else="false"/>
                            </ctrl:checkbox>
                        </fs2:row>

                        <ctrl:checkbox id="is_need_sickList" label="Требуется ЛН"/>

                    </fs2:field-set>

                </wgt:form>

            </container>

            <container id="sickList" depends-on="medicalHistoryContainerForm" dependency-condition="medicalHistoryContainerForm.isN2OModuleActive == true"
                       refresh-dependent-container="true">
                <wgt:table detail-field-id="case.id" master-field-id="case.id">
                    <wgt:query-id>mdHistoryForm_sickList</wgt:query-id>
                    <wgt:size>20</wgt:size>
                    <wgt:name>Листы нетрудоспособности</wgt:name>

                    <wgt:columns>
                        <wgt:column column-field-id="code"/>
                        <wgt:column column-field-id="issueDt"/>
                        <wgt:column column-field-id="closeDate"/>
                        <wgt:column column-field-id="type"/>
                        <wgt:column column-field-id="disabilityReason"/>
                        <wgt:column column-field-id="state"/>
                        <wgt:column column-field-id="transferFromClinic">
                            <wgt:checkbox/>
                        </wgt:column>

                    </wgt:columns>

                    <wgt:filters>
                        <ctrl:select id="issuedBy" label="Выдан">
                            <ctrl:options>
                                <ctrl:option>{"id":1, "name":"В другом МО"}</ctrl:option>
                                <ctrl:option>{"id":2, "name":"В нашем МО"}</ctrl:option>
                            </ctrl:options>
                        </ctrl:select>
                    </wgt:filters>

                    <wgt:action-menu>

                        <wgt:menu-item label="Добавить" context="false" id="create">
                            <wgt:show-modal
                                                                page-id="sicksheet"
                                                                page-name="Создание листа нетрудоспособности"
                                                                container-id="main"
                                                                action-id="createOrUpdateSickSheet"
                                                                master-field-id="case.id"
                                                                detail-field-id="mcase.id"
                                                                refresh-on-close="true"
                                                                width="780px">
                            </wgt:show-modal>
                        </wgt:menu-item>

                        <wgt:menu-item label="Выдан в другом МО" context="false" id="issuedAnotherClinicCreate">
                            <wgt:show-modal page-id="sicksheet_another_clinic" master-field-id="case.id"
                                                 detail-field-id="mcase.id" width="780px" action-id="createOrUpdateSickSheet">
                                <wgt:pre-filters>
                                    <wgt:pre-filter field-id="isAnotherClinic" value="true"></wgt:pre-filter>
                                </wgt:pre-filters>
                            </wgt:show-modal>
                        </wgt:menu-item>

                        <wgt:menu-item label="Изменить" context="true" id="update">
                            <wgt:show-modal
                                    page-id="sicksheet"
                                    page-name="Изменение листа нетрудоспособности"
                                    container-id="main"
                                    action-id="createOrUpdateSickSheet"
                                    refresh-on-close="true"
                                    width="780px"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>transferFromClinic != true</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Изменить" context="true" id="issuedAnotherClinicUpdate"
                                       icon="icon-pencil">
                            <wgt:show-modal page-id="sicksheet_another_clinic" master-field-id="id"
                                                 detail-field-id="id"  width="780px" action-id="createOrUpdateSickSheet">
                            </wgt:show-modal>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>transferFromClinic == true</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Удалить" id="delete" context="true">
                            <wgt:invoke-action action-id="delete" confirmation="true"/>
                        </wgt:menu-item>

                    </wgt:action-menu>

                    <wgt:sortings>
                        <wgt:sorting sorting-field-id="issueDt" direction="DESC"/>
                    </wgt:sortings>

                </wgt:table>
            </container>

            <container id="sickListLSD" depends-on="medicalHistoryContainerForm" dependency-condition="medicalHistoryContainerForm.isN2OModuleActive == false"
                       refresh-dependent-container="true">
                <wgt:table detail-field-id="case.id" master-field-id="case.id">
                    <wgt:query-id>mdHistoryForm_sickList_LSD</wgt:query-id>
                    <wgt:size>20</wgt:size>
                    <wgt:name>Листы нетрудоспособности</wgt:name>

                    <wgt:columns>
                        <wgt:column column-field-id="code"/>
                        <wgt:column column-field-id="issueDt"/>
                        <wgt:column column-field-id="closeDate"/>
                        <wgt:column column-field-id="type"/>
                        <wgt:column column-field-id="disabilityReason"/>
                        <wgt:column column-field-id="state"/>
                        <wgt:column column-field-id="transferFromClinic">
                            <wgt:checkbox/>
                        </wgt:column>

                    </wgt:columns>

                    <wgt:filters>
                        <ctrl:select id="issuedBy" label="Выдан">
                            <ctrl:options>
                                <ctrl:option>{"id":1, "name":"В другом МО"}</ctrl:option>
                                <ctrl:option>{"id":2, "name":"В нашем МО"}</ctrl:option>
                            </ctrl:options>
                        </ctrl:select>
                    </wgt:filters>

                    <wgt:action-menu>

                        <wgt:menu-item label="Добавить" context="false" id="create">
                            <wgt:a href="/sicklist/sicklist/new?value=:case.patient.id:&amp;cid=:case.id:&amp;backUrl=%2Fresource%2F0%2Fhtml%2Fself-close.html" target="newWindow"/>
                        </wgt:menu-item>

                        <wgt:menu-item label="Выдан в другом МО" context="false" id="issuedAnotherClinicCreate">
                            <wgt:show-modal-form form-id="sickListIssuedAnotherClinic" master-field-id="id"
                                                 detail-field-id="id">
                                <wgt:edit model="default" refresh-after-submit="true">
                                    <wgt:invoke-action action-id="save"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                        </wgt:menu-item>

                        <wgt:menu-item label="Изменить" context="true" id="update">
                            <wgt:a href="/sicklist/sicklist/:id:/edit?backUrl=%2Fresource%2F0%2Fhtml%2Fself-close.html"
                                   target="newWindow"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>transferFromClinic != true</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Изменить" context="true" id="issuedAnotherClinicUpdate"
                                       icon="icon-pencil">
                            <wgt:show-modal-form form-id="sickListIssuedAnotherClinic" master-field-id="id"
                                                 detail-field-id="id">
                                <wgt:edit model="query" refresh-after-submit="true">
                                    <wgt:invoke-action action-id="save"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>transferFromClinic == true</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item label="Удалить" id="delete" context="true">
                            <wgt:invoke-action action-id="delete" confirmation="true"/>
                        </wgt:menu-item>

                    </wgt:action-menu>

                    <wgt:sortings>
                        <wgt:sorting sorting-field-id="issueDt" direction="DESC"/>
                    </wgt:sortings>

                </wgt:table>
            </container>

            <container id="mdHistoryTreatmentPlan" depends-on="medicalHistoryContainerForm">
                <wgt:table master-field-id="case.id" detail-field-id="case.id">
                    <wgt:name>План лечения</wgt:name>
                    <wgt:query-id>mdHistoryTreatmentPlanList</wgt:query-id>
                    <wgt:size>10</wgt:size>
                    <wgt:columns>
                        <wgt:column column-field-id="num"/>
                        <wgt:column column-field-id="create_dt"/>
                        <wgt:column column-field-id="chemo_phase.name"/>
                        <wgt:column column-field-id="chemo_regimen.name"/>
                        <wgt:column column-field-id="treatment_result.name"/>
                        <wgt:column column-field-id="end_dt"/>
                        <wgt:column column-field-id="weight_from"/>
                        <wgt:column column-field-id="weight_to"/>
                    </wgt:columns>
                    <wgt:filters>
                        <ctrl:input-text id="num" label="№ карты лечения"/>
                        <ctrl:date-time id="create_dt" label="Дата начала"/>
                        <ctrl:classifier id="chemo_phase" label="Фаза ХТ" search-as-you-type="true">
                            <ctrl:query query-id="chemoPhase" label-field-id="name" value-field-id="id"/>
                        </ctrl:classifier>
                        <ctrl:classifier id="chemo_regimen" label="Режим ХТ" search-as-you-type="true">
                            <ctrl:query query-id="chemoRegimen" label-field-id="name" value-field-id="id"/>
                        </ctrl:classifier>
                        <ctrl:classifier id="treatment_result" label="Исход" search-as-you-type="true">
                            <ctrl:query query-id="treatmentResult" label-field-id="name" value-field-id="id"/>
                        </ctrl:classifier>
                    </wgt:filters>
                    <wgt:action-menu>

                        <wgt:menu-item id="createTreatmentPlan" context="false" label="Добавить" icon="icon-plus">
                            <wgt:show-modal-form
                                    form-id="mdHistoryTreatmentPlanCreate"
                                    width="90%;max-width:900px;min-width:500px;"
                                    refresh-on-close="true">
                                <wgt:edit model="default">
                                    <wgt:invoke-action action-id="createTreatmentPlanInHospital"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                        </wgt:menu-item>
                        <wgt:menu-item id="editTreatmentPlan" context="true" label="Изменить" icon="icon-pencil">
                            <wgt:show-modal-form
                                    form-id="mdHistoryTreatmentPlanEdit"
                                    width="90%;max-width:900px;min-width:500px;"
                                    master-field-id="id"
                                    detail-field-id="id"
                                    refresh-on-close="true">
                                <wgt:edit model="query">
                                    <wgt:invoke-action action-id="updateTreatmentPlanInHospital"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                        </wgt:menu-item>
                        <wgt:menu-item label="Удалить" id="deleteTreatmentPlan" context="true">
                            <wgt:invoke-action action-id="deleteTreatmentPlan" confirmation="true"/>
                        </wgt:menu-item>
                        <wgt:menu-item id="showTreatmentPlan" context="true" label="Просмотреть">
                            <wgt:show-modal page-id="mdHistoryTreatmentPlanShow"
                                            master-field-id="id"
                                            detail-field-id="id">
                            </wgt:show-modal>
                        </wgt:menu-item>
                    </wgt:action-menu>
                </wgt:table>
            </container>

            <container id="epicrisis" depends-on="medicalHistoryContainerForm">
                <wgt:table master-field-id="id" detail-field-id="step.id">
                    <wgt:name>Эпикризы</wgt:name>
                    <wgt:query-id>epicrisisList</wgt:query-id>
                    <wgt:size>10</wgt:size>
                    <wgt:columns>
                        <wgt:column column-field-id="create_dt"/>
                        <wgt:column column-field-id="type_name"/>
                        <wgt:column column-field-id="department_name"/>
                        <wgt:column column-field-id="doctor.fio"/>
                        <wgt:column column-field-id="status_name"/>
                    </wgt:columns>
                    <wgt:filters>
                        <ctrl:date-time id="create_dt" label="Дата создания"/>
                        <ctrl:classifier id="type" label="Тип эпикриза" search-as-you-type="true">
                            <ctrl:query query-id="epicrisisType" label-field-id="name" value-field-id="id"/>
                        </ctrl:classifier>
                        <ctrl:classifier id="status" label="Статус" search-as-you-type="true">
                            <ctrl:query query-id="epicrisisStatus" label-field-id="name" value-field-id="id"/>
                        </ctrl:classifier>
                        <ctrl:classifier id="department" label="Отделение" search-as-you-type="true">
                            <ctrl:query query-id="hosp_departmentByCase" value-field-id="id" label-field-id="name">
                                <ctrl:pre-filters>
                                    <ctrl:pre-filter field-id="caseId" ref="case.id"/>
                                </ctrl:pre-filters>
                            </ctrl:query>
                        </ctrl:classifier>
                    </wgt:filters>

                    <wgt:action-menu>
                        <wgt:menu-item id="create" label="Создать" type="textAndIcon" context="false">
                            <wgt:show-modal-form form-id="shapeEpicrisis" width="500px" page-name="Создание эпикриза">
                                <wgt:edit focus-after-submit="true" refresh-after-submit="true">
                                    <wgt:invoke-action action-id="create"/>
                                </wgt:edit>
                                <wgt:pre-filters>
                                    <wgt:pre-filter field-id="hospRecId" ref="step.id"/>
                                </wgt:pre-filters>
                            </wgt:show-modal-form>
                        </wgt:menu-item>

                        <wgt:menu-item id="shape" label="Сформировать" type="textAndIcon" context="true"
                                       icon="icon-list-alt">
                            <wgt:show-modal-form form-id="epicrisisForm${templateId}" width="950px"
                                                 page-name="Формирование эпикриза">
                                <wgt:edit>
                                    <wgt:invoke-action action-id="update"/>
                                </wgt:edit>
                                <wgt:pre-filters>
                                    <wgt:pre-filter field-id="generate" value="true"/>
                                    <wgt:pre-filter field-id="patientId" ref="patient.id"/>
                                    <wgt:pre-filter field-id="caseId" ref="case.id"/>
                                    <wgt:pre-filter field-id="typeId" ref="type.id"/>
                                    <wgt:pre-filter field-id="hospRecId" ref="step.id"/>
                                    <wgt:pre-filter field-id="emplPosId" ref="doctor.id"/>
                                    <wgt:pre-filter field-id="templateId" ref="templateId"/>
                                </wgt:pre-filters>
                            </wgt:show-modal-form>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression><![CDATA[ (status.id == 1) && !is_shape]]></wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="copy" label="Копировать" type="textAndIcon"
                                       icon="glyphicons glyphicons-duplicate" context="true">
                            <wgt:show-modal-form form-id="epicrisisForm${templateId}" width="950px"
                                                 page-name="Копирование эпикриза">
                                <wgt:edit>
                                    <wgt:invoke-action action-id="copy"/>
                                </wgt:edit>
                                <wgt:pre-filters>
                                    <wgt:pre-filter field-id="copy" value="true"/>
                                </wgt:pre-filters>
                            </wgt:show-modal-form>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression><![CDATA[is_shape]]></wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="update" label="Редактировать" type="textAndIcon" context="true">
                            <wgt:show-modal-form form-id="epicrisisForm${templateId}" width="950px"
                                                 page-name="Редактирование эпикриза">
                                <wgt:edit create-more="false">
                                    <wgt:invoke-action action-id="update"/>
                                </wgt:edit>
                            </wgt:show-modal-form>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression><![CDATA[is_shape]]></wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="read" label="Просмотреть" type="textAndIcon" icon="icon-search"
                                       context="true">
                            <wgt:show-modal-form form-id="epicrisisForm${templateId}" width="950px"
                                                 page-name="Просмотр эпикриза"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression><![CDATA[is_shape]]></wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="delete" label="Удалить" type="textAndIcon" context="true">
                            <wgt:invoke-action action-id="delete"/>
                            <wgt:conditions>
                                <wgt:enabling-condition>
                                    <wgt:expression>status_name!='утвержден'</wgt:expression>
                                    <wgt:tooltip>Нельзя удалять подписанные документы.</wgt:tooltip>
                                </wgt:enabling-condition>
                            </wgt:conditions>
                        </wgt:menu-item>
                    </wgt:action-menu>
                </wgt:table>
            </container>

            <container id="accidentRecord" depends-on="medicalHistoryContainerForm" dependency-condition="medicalHistoryContainerForm.isRegisteredAccident" refresh-dependent-container="true" >
                <wgt:form ref-id="accidentRecord" detail-field-id="case.id" master-field-id="case.id"/>
            </container>
        </region>

    </regions>

</page>

