<?xml version='1.0' encoding='UTF-8'?>
<page xmlns="http://n2oapp.net/framework/config/schema/page-1.0"
      xmlns:ctrl="http://n2oapp.net/framework/config/schema/n2o-control-1.0"
      xmlns:wgt="http://n2oapp.net/framework/config/schema/n2o-widget-2.0"
      xmlns:fs="http://n2oapp.net/framework/config/schema/fieldset-2.0"
      xmlns:rc="http://atria.cz/app/config/schema/rmis-control-1.0">
    <!--<id>card_paper</id>-->
    <name>Карта вызова по бумажной технологии</name>
    <object-id>card_paper</object-id>
    <layout>n2o/layout/single</layout>
    <regions>
        <region place="single" type="none">
            <container id="card_paper" place="single">
                <wgt:form src="ext/css/amb03-control-container-ambcard" customize="css" css-class="card-from n2o-form">
                    <wgt:name>Карта вызова (врача)</wgt:name>
                    <wgt:query-id>card_paper</wgt:query-id>
                    <wgt:default-values-query-id>card_paper_def</wgt:default-values-query-id>
                    <fs:field-set>
                        <ctrl:output-text id="errorText" label="Отсутствует открытая смена, создание карты без смены невозможно!"
                                          dependency-condition="change == null" label-style="color:red;width:100%;font-weight: bold;">
                            <ctrl:validations>
                                <ctrl:validation ref-id="checkNullChange" side="client"/>
                            </ctrl:validations>
                        </ctrl:output-text>
                    </fs:field-set>
                    <fs:field-set field-label-location="left" header="none">
                        <fs:row>
                            <ctrl:date-time id="data" label="Смена" required="true"  css-class="ambcard-langlabel ambcard-birth_dt"
                                            default-value="today()" dependency-condition="(typeof id == 'undefined') || (id == null)">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="AfterDatacheck" side="client"/>
                                    <ctrl:validation ref-id="BeforDatacheck" side="client"/>
                                </ctrl:validations>
                            </ctrl:date-time>
                            <ctrl:input-text id="number" label="№" required="true" css-class="ambcard-number ambcard-boldtext"
                                             dependency-condition="(typeof id == 'undefined') || (id == null)" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="NumberCheck" side="client,server"/>
                                    <ctrl:validation ref-id="NumberUnique" side="client,server"/>
                                </ctrl:validations>
                            </ctrl:input-text>
                            <ctrl:output-text id="number" label="№" css-class="ambcard-number ambcard-boldtext"
                                              dependency-condition="(typeof id != 'undefined') &amp;&amp; (id != null)" copied="false"/>
                            
                            <ctrl:classifier id="call_kind" label="Вид" label-style="width:30px;" css-class="ambcard-kind"
                                             dependency-condition="(typeof id == 'undefined') || (id == null)" required="true" search-as-you-type="true" autoselect-alone="true">
                                <ctrl:query query-id="call_kind" value-field-id="id" label-field-id="code"/>
                            </ctrl:classifier>
                            <ctrl:output-text id="call_kind.code" label="Вид" css-class="ambcard-kind" readonly="true" dependency-condition="(typeof id != 'undefined') &amp;&amp; (id != null)"/>
                            
                            <ctrl:classifier id="call_type" label="Тип" dependency-condition="(typeof id == 'undefined') || (id == null)" required="true" css-class="ambcard-type"
                                             search-as-you-type="true" autoselect-alone="true">
                                <ctrl:query query-id="call_type" value-field-id="id" label-field-id="name"/>
                            </ctrl:classifier>
                            <ctrl:output-text id="call_type.name" label="Тип" readonly="true" dependency-condition="(typeof id != 'undefined') &amp;&amp; (id != null)" css-class="ambcard-type"/>

                            <ctrl:classifier id="employee" label="Принял" required="true" css-class="ambcard-remp ambcard-boldtext"
                                             dependency-condition="(typeof id == 'undefined') || (id == null)" search-as-you-type="true" autoselect-alone="true">
                                <ctrl:query query-id="employee" label-field-id="namePos" value-field-id="id">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="statId" value="#{org.id?}"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                            </ctrl:classifier>
                            <ctrl:output-text id="employee.namePos" readonly="true" css-class="ambcard-remp ambcard-boldtext" dependency-condition="(typeof id != 'undefined') &amp;&amp; (id != null)"/>

                            <ctrl:output-text id="from_time" label="" css-class="ambcard-receipt_time ambcard-no-label ambcard-boldtext" dependency-condition="(typeof id != 'undefined') &amp;&amp; (id != null)"/>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set>
                        <fs:row>
                            <ctrl:classifier id="brg" label="Бригада" required="true" css-class="ambcard-transmit"
                                             dependency-condition="(typeof id == 'undefined') || (id == null)" search-as-you-type="true" autoselect-alone="true">
                                <ctrl:query query-id="res_team" label-field-id="name" value-field-id="id">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="station.id" value="#{org.id?}"/>
                                        <ctrl:pre-filter field-id="substation.id" value="#{dep.id?}"/>
                                        <ctrl:pre-filter field-id="is_edate" ref="data"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                            </ctrl:classifier>
                            
                            <ctrl:output-text id="brg.name" label="" css-class="ambcard-brig ambcard-no-label ambcard-boldtext" dependency-condition="(typeof id != 'undefined') &amp;&amp; (id != null)"/>

                            <ctrl:classifier id="transmit" label="Способ передачи" css-class="ambcard-transmit ambcard-boldtext"
                                             dependency-condition="(typeof id == 'undefined') || (id == null)" required="true" search-as-you-type="true" autoselect-alone="true">
                                <ctrl:query query-id="transmit" label-field-id="name" value-field-id="id"/>
                                <ctrl:default-model>
                                    <ctrl:value field-id="id">2</ctrl:value>
                                    <ctrl:value field-id="name">по рации</ctrl:value>
                                </ctrl:default-model>
                            </ctrl:classifier>
                            <ctrl:output-text id="transmit.name" label="" css-class="ambcard-transmit ambcard-no-label ambcard-boldtext" dependency-condition="(typeof id != 'undefined') &amp;&amp; (id != null)"/>
                            
                            <ctrl:classifier id="route_reg" label="Передал" required="true" css-class="ambcard-remp ambcard-boldtext"
                                             dependency-condition="(typeof id == 'undefined') || (id == null)" search-as-you-type="true" autoselect-alone="true">
                                <ctrl:query query-id="employee" label-field-id="namePos" value-field-id="id">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="statId" value="#{org.id?}"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                            </ctrl:classifier>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="line" label="Время (часы, минуты)" field-label-location="top" css-class="ambcard-fstime">
                        <fs:row>
                            <ctrl:masked-input id="receipt_time" label="Прием вызова" css-class="ambcard-time" mask="99:99" required="true"
                                               dependency-condition="(typeof id == 'undefined') || (id == null)" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="validate_receipt_time" side="client"/>
                                </ctrl:validations>
                            </ctrl:masked-input>
                            <ctrl:masked-input id="receipt_time" label="Прием вызова" css-class="ambcard-time" mask="99:99" readonly="true"
                                               dependency-condition="(typeof id != 'undefined') &amp;&amp; (id != null)" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="validate_receipt_time" side="client"/>
                                </ctrl:validations>
                            </ctrl:masked-input>

                            <ctrl:masked-input id="transmit_time" label="Передан бригаде" css-class="ambcard-time" mask="99:99" required="true"
                                               dependency-condition="(typeof id == 'undefined') || (id == null)" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="validate_transmit_time" side="client"/>
                                </ctrl:validations>
                            </ctrl:masked-input>
                            <ctrl:masked-input id="transmit_time" label="Передан бригаде" css-class="ambcard-time" mask="99:99" readonly="true"
                                               dependency-condition="(typeof id != 'undefined') &amp;&amp; (id != null)" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="validate_transmit_time" side="client"/>
                                </ctrl:validations>
                            </ctrl:masked-input>

                            <ctrl:masked-input id="exit_time" label="Выезд с п/ст" css-class="ambcard-time" mask="99:99" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="validate_exit_time" side="client"/>
                                </ctrl:validations>
                            </ctrl:masked-input>
                            <ctrl:masked-input id="coming_time" label="Прибытие на вызов" css-class="ambcard-time" mask="99:99" required="true" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="validate_coming_time" side="client"/>
                                </ctrl:validations>
                            </ctrl:masked-input>
                            <ctrl:masked-input id="transportation_time" label="Начало трансп-ки" css-class="ambcard-time" mask="99:99" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="validate_transportation_time" side="client"/>
                                </ctrl:validations>
                            </ctrl:masked-input>
                            <ctrl:masked-input id="toclinic_time" label="Прибытие в МО" css-class="ambcard-time" mask="99:99" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="validate_toclinic_time" side="client"/>
                                </ctrl:validations>
                            </ctrl:masked-input>
                            <ctrl:masked-input id="time_toclinic" label="Приём в МО" css-class="ambcard-time" mask="99:99" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="validate_time_toclinic" side="client"/>
                                </ctrl:validations>
                            </ctrl:masked-input>
                        </fs:row>
                        <fs:row>
                            <ctrl:masked-input id="time_transmit" label="Ожидание бригады" css-class="ambcard-time" mask="99:99" readonly="true" copied="false">
                                <ctrl:set-value-expression on="receipt_time,transmit_time">
                                    <![CDATA[
                                    if (moment(transmit_time,'HH:mm').diff(moment(receipt_time,'HH:mm'))/1000/60 >= 0) (moment(transmit_time,'HH:mm').diff(moment(receipt_time,'HH:mm'))/1000/60); else 1440 + (moment(transmit_time,'HH:mm').diff(moment(receipt_time,'HH:mm'))/1000/60)
                                    ]]>
                                </ctrl:set-value-expression>
                            </ctrl:masked-input>
                            <ctrl:masked-input id="time_arrival" label="Доезд до места" css-class="ambcard-time" mask="99:99" readonly="true" copied="false">
                                <ctrl:set-value-expression on="coming_time,receipt_time">
                                    if (moment(coming_time,'HH:mm').diff(moment(receipt_time,'HH:mm'))/1000/60 >= 0) (moment(coming_time,'HH:mm').diff(moment(receipt_time,'HH:mm'))/1000/60); else 1440 + (moment(coming_time,'HH:mm').diff(moment(receipt_time,'HH:mm'))/1000/60)
                                </ctrl:set-value-expression>
                            </ctrl:masked-input>
                            <ctrl:hidden id="timpat">
                                <ctrl:set-value-expression on="coming_time,end_time,time_toclinic,toclinic_time,transportation_time">
                                    if ((typeof transportation_time != 'undefined')&amp;&amp;(transportation_time != null)&amp;&amp;(transportation_time != '__:__')) (moment(transportation_time,'HH:mm').diff(moment(coming_time,'HH:mm'))/1000/60); else
                                    if ((typeof toclinic_time != 'undefined')&amp;&amp;(toclinic_time != null)&amp;&amp;(toclinic_time != '__:__')) (moment(toclinic_time,'HH:mm').diff(moment(coming_time,'HH:mm'))/1000/60); else
                                    if ((typeof time_toclinic != 'undefined')&amp;&amp;(time_toclinic != null)&amp;&amp;(time_toclinic != '__:__')) (moment(time_toclinic,'HH:mm').diff(moment(coming_time,'HH:mm'))/1000/60); else
                                    (moment(end_time,'HH:mm').diff(moment(coming_time,'HH:mm'))/1000/60)
                                </ctrl:set-value-expression>
                            </ctrl:hidden>
                            <ctrl:masked-input id="time_patient" label="У больного (на месте)" css-class="ambcard-time" mask="99:99" readonly="true" copied="false">
                                <ctrl:set-value-expression on="timpat">
                                    if (timpat >= 0) timpat; else 1440 + timpat;
                                </ctrl:set-value-expression>
                            </ctrl:masked-input>

                            <ctrl:masked-input id="end_time" label="Окончание вызова" css-class="ambcard-time" mask="99:99" required="true" dependency-condition="(typeof id == 'undefined') || (id == null)" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="validate_end_time" side="client"/>
                                </ctrl:validations>
                            </ctrl:masked-input>

                            <ctrl:masked-input id="tosubstation_time" label="Возвращение на п/ст" css-class="ambcard-time" mask="99:99" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="validate_tosubstation_time" side="client"/>
                                </ctrl:validations>
                            </ctrl:masked-input>

                            <ctrl:input-text id="calltime" label="Длитель- ность" css-class="ambcard-time" readonly="true"
                                               dependency-condition="(typeof id == 'undefined') || (id == null)" copied="false">
                                <ctrl:set-value-expression on="receipt_time,end_time">
                                    if (moment(end_time,'HH:mm').diff(moment(receipt_time,'HH:mm'))/1000/60 >= 0) (moment(end_time,'HH:mm').diff(moment(receipt_time,'HH:mm'))/1000/60); else 1440 + (moment(end_time,'HH:mm').diff(moment(receipt_time,'HH:mm'))/1000/60)
                                </ctrl:set-value-expression>
                            </ctrl:input-text>
                            <ctrl:masked-input id="calltime" label="Длитель- ность" css-class="ambcard-time" mask="99:99" readonly="true" dependency-condition="(typeof id != 'undefined') &amp;&amp; (id != null)" copied="false"/>

                            <ctrl:masked-input id="death_time" label="Конст. смерти" css-class="ambcard-time" mask="99:99" copied="false">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="validate_death_time" side="client"/>
                                </ctrl:validations>
                            </ctrl:masked-input>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set field-label-location="left" css-class="ambcard-fsnotes">
                        <ctrl:output-text id="notes" readonly="true" label="" label-style="width:0;" copied="false">
                            <ctrl:validations>
                                <ctrl:validation ref-id="checkPaperCardTime" side="client,server"/>
                            </ctrl:validations>
                        </ctrl:output-text>
                    </fs:field-set>
                    <fs:field-set header="line" label="Пациент" field-label-location="left" css-class="ambcard-fsresult">
                        <fs:row>
                            <ctrl:input-text id="indDoc.number" label="Номер документа УДЛ/ОМС" css-class="ambcard-enp" label-style="width:200px;"/>
                        </fs:row>
                        <fs:row>
                            <ctrl:classifier id="individual" label="Пациент" css-class="ambcard-label" control-style="width:675px;"
                                             autoselect-alone="true" search-as-you-type="true">
                                <ctrl:query query-id="patientsSearch" value-field-id="id" label-field-id="displayName">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="document" ref="indDoc.number"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                                <ctrl:show-modal page-id="patientsList" result-container-id="pats" width="42%"/>
                                <ctrl:validations>
                                    <ctrl:validation ref-id="PatUnique" side="client"/>
                                </ctrl:validations>
                                <ctrl:actions>
                                    <ctrl:button icon="icon-plus" type="icon" label="Создать">
                                        <ctrl:a href="/pats/patients/new?backUrl=%2Fpats%2Fresource%2F0%2Fhtml%2Fself-close.html" target="newWindow"/>
                                        <ctrl:dependencies>
                                            <ctrl:visibility-condition>!is_offline</ctrl:visibility-condition>
                                        </ctrl:dependencies>
                                    </ctrl:button>
                                    <ctrl:button icon="icon-pencil" type="icon" label="Редактировать">
                                        <ctrl:a href="/pats/patients/:individual.id:/edit?backUrl=%2Fpats%2Fresource%2F0%2Fhtml%2Fself-close.html" target="newWindow"/>
                                        <ctrl:dependencies>
                                            <ctrl:enabling-condition>individual.id != null</ctrl:enabling-condition>
                                            <ctrl:visibility-condition>!is_offline</ctrl:visibility-condition>
                                        </ctrl:dependencies>
                                    </ctrl:button>
                                </ctrl:actions>
                            </ctrl:classifier>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="none" css-class="ambcard-fspatientfio" field-label-location="left" >
                        <fs:row>
                            <ctrl:input-text id="individual.surname" css-class="ambcard-label" copied="false">
                                <ctrl:dependencies>
                                    <ctrl:enabling-condition>
                                        (typeof individual == 'undefined') || (individual == null) || (individual.id == null) || (individual.can_modif == true)
                                    </ctrl:enabling-condition>
                                </ctrl:dependencies>
                            </ctrl:input-text>
                        </fs:row>
                        <fs:row>
                            <ctrl:input-text id="individual.name" css-class="ambcard-label" copied="false">
                                <ctrl:dependencies>
                                    <ctrl:enabling-condition>
                                        (typeof individual == 'undefined') || (individual == null) || (individual.id == null) || (individual.can_modif == true)
                                    </ctrl:enabling-condition>
                                </ctrl:dependencies>
                            </ctrl:input-text>
                        </fs:row>
                        <fs:row>
                            <ctrl:input-text id="individual.patrName" label="Отчество" css-class="ambcard-label" copied="false">
                                <ctrl:dependencies>
                                    <ctrl:enabling-condition>
                                        (typeof individual == 'undefined') || (individual == null) || (individual.id == null) || (individual.can_modif == true)
                                    </ctrl:enabling-condition>
                                </ctrl:dependencies>
                            </ctrl:input-text>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="none" label="" css-class="ambcard-fspatientage" field-label-location="left">
                        <fs:row>
                            <ctrl:hidden id="bd">
                                <ctrl:set-value-expression on="individual" on-load="true" on-non-empty="true" on-invisible="true">
                                    if ((typeof individual != 'undefined')&amp;&amp;(individual != null)&amp;&amp;(individual.id != null)) individual.birthDateWithAge; else null;
                                </ctrl:set-value-expression>
                            </ctrl:hidden>
                            <ctrl:date-time id="individual.birthDate" label="Дата рожд." css-class="ambcard-label ambcard-birth_dt" copied="false">
                                <ctrl:set-value-expression on="bd" on-load="true" on-non-empty="true" on-invisible="true">
                                    if ((typeof bd != 'undefined')&amp;&amp;(bd != null))
                                        moment(bd.substring(0,10),'DD.MM.YYYY').format('DD.MM.YYYY HH:mm')
                                    ; else throw '!'
                                </ctrl:set-value-expression>
                                <ctrl:validations>
                                    <ctrl:validation ref-id="checkAge" side="client"/>
                                </ctrl:validations>
                            </ctrl:date-time>
                            <ctrl:classifier id="gender" label="Пол" css-class="ambcard-gender" copied="false" required="true">
                                <ctrl:query query-id="amb_gender" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="id" ref="individual.genderId"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                                <ctrl:set-value-expression on="individual" on-non-empty="true" on-readonly="true">
                                    <!-- если пациент вернулся с компонента -->
                                    if ((typeof individual != 'undefined')&amp;&amp;(individual != null)&amp;&amp;(individual.genderId != null)){
                                        var o = new Object();
                                        o.id = individual.genderId;
                                        o.name = individual.genderName;
                                        o;
                                    <!-- при удалении пациента через компонент -->
                                    } else if ((typeof individual == 'undefined')&amp;&amp;(individual == null)&amp;&amp;individual.genderId == null){
                                        null;
                                    <!-- при ручном вводе пациента -->
                                    } else if ((typeof individual != 'undefined')&amp;&amp;(individual != null)&amp;&amp;individual.genderId == null){
                                        var o = new Object();
                                        o.id = gender.id;
                                        o.name = gender.name;
                                        o;
                                    }
                                </ctrl:set-value-expression>
                            </ctrl:classifier>
                        </fs:row>
                        <fs:row>
                            <ctrl:masked-input id="age_years" label="Возраст" css-class="ambcard-age-y" copied="false" mask="?999">
                                <ctrl:set-value-expression on="individual.birthDate" on-load="false">
                                    <![CDATA[
                                    if ((typeof individual != 'undefined')&&(individual != null)&&(individual.birthDate != null)){
                                        var yrs = moment().diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'years');
                                        if ((yrs >= 1)) yrs;
                                        else null;
                                    } else null;
                                    ]]>
                                </ctrl:set-value-expression>
                            </ctrl:masked-input>
                            <ctrl:output-text id="age_years_label" label="" css-class="ambcard-age-nolabel" domain="string" default-value="л.">
                                <ctrl:set-value-expression on="individual.birthDate">
                                    <![CDATA[
                                        var years = new Object();
                                        if ((individual.birthDate != null)&&(moment().diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'years') >= 1)){
                                            years = moment().diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'years');
                                            var lastChar = years % 10;
                                            if ((lastChar == 0 || (lastChar >= 5 && lastChar <= 9)) || (age_years == 11 || age_years == 12 || age_years == 13 || age_years == 14)) {
                                                'л.';
                                            } else {
                                                'г.';
                                            }
                                        }
                                    ]]>
                                </ctrl:set-value-expression>
                                <ctrl:set-value-expression on="age_years">
                                    <![CDATA[
                                        if(age_years != null){
                                            var lastChar = parseInt(age_years.substring(age_years.length - 1));
                                            if ((lastChar == 0 || (lastChar >= 5 && lastChar <= 9)) || (age_years == 11 || age_years == 12 || age_years == 13 || age_years == 14)) {
                                                'л.';
                                            } else {
                                                'г.';
                                            }
                                        }
                                      ]]>
                                </ctrl:set-value-expression>
                            </ctrl:output-text>
                            <ctrl:masked-input id="age_months" label="" css-class="ambcard-age" label-style="display:none;" copied="false" mask="?99">
                                <ctrl:set-value-expression on="individual.birthDate" on-load="false">
                                    <![CDATA[
                                    if((typeof individual != 'undefined')&&(individual != null)&&(individual.birthDate != null)){
                                        var mes = moment().diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'months');
                                        var yrs = moment().diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'years');

                                        if  ((yrs < 3) && (mes >= 1) && ((mes - yrs * 12) != 0)){
                                                if (mes > 11) {(mes - yrs * 12);
                                                } else {mes;}
                                        } else null;
                                    } else null;
                                    ]]>
                                </ctrl:set-value-expression>
                            </ctrl:masked-input>
                            <ctrl:output-text id="age_months_label" css-class="ambcard-age-nolabel" label="" default-value="мес." domain="string"/>
                            <ctrl:masked-input id="age_days" label="" css-class="ambcard-age" label-style="display:none;" copied="false" mask="?99">
                                <ctrl:set-value-expression on="individual.birthDate" on-load="false">
                                    <![CDATA[
                                    if((typeof individual != 'undefined')&&(individual != null)&&(individual.birthDate != null)){
                                        if  ((moment().diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'years') < 1) &&
                                        (moment().diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'months') < 1)
                                        ) moment().diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'days');
                                        else null;
                                    } else null;
                                    ]]>
                                </ctrl:set-value-expression>
                            </ctrl:masked-input>
                            <ctrl:output-text id="age_days_label" css-class="ambcard-age-nolabel" label="" default-value="дн." domain="string"/>
                        </fs:row>
                        <fs:row>
                            <ctrl:classifier id="citizenship_type" label="Житель" copied="false" search-as-you-type="true" autoselect-alone="true">
                                <ctrl:query query-id="citizenship_type" label-field-id="name" value-field-id="id"/>
                            </ctrl:classifier>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="line" label="Адрес вызова" css-class="ambcard-fsaddress">
                        <fs:row>
                            <ctrl:classifier id="call_place" label="Место вызова" css-class="ambcard-address" required="true" search-as-you-type="true">
                                <ctrl:query query-id="call_place" value-field-id="id" label-field-id="name"/>
                                <ctrl:set-value-expression on="call_kind,call_type" on-load="false" on-non-empty="false">
                                    if ((call_kind.id != 5) &amp;&amp; (call_type.id != 2)&amp;&amp;(call_type.id != 3)&amp;&amp;(call_kind.id != 7))
                                    {
                                    var o = new Object();
                                    o.id = 2;
                                    o.name = 'квартира';
                                    o.search = false;
                                    o;
                                    }else if (call_kind.id == 7)
                                    {
                                    var o = new Object();
                                    o.id = 13;
                                    o.name = 'подстанция';
                                    o.search = true;
                                    o;
                                    }else {throw '!'}
                                </ctrl:set-value-expression>
                            </ctrl:classifier>
                            <ctrl:input-text id="place_note" label="" css-class="ambcard-address-note" label-style="width:0;" copied="false"/>
                        </fs:row>
                        <fs:row>
                            <ctrl:hidden id="station.id" default-value="#{org.id?}"/>
                            <ctrl:hidden id="station.name" default-value="#{org.name?}"/>
                            <ctrl:hidden id="station.addr" default-value="#{org.addr?}"/>
                            <ctrl:hidden id="station.addrname" default-value="#{org.addrname?}"/>
                            <ctrl:classifier id="org" label="Организация" dependency-condition="call_place.search == true" css-class="ambcard-address-org" search-as-you-type="true">
                                <ctrl:query query-id="amborg" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="PRId" ref="call_place.PRId"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                                <ctrl:set-value-expression on="call_place" on-load="false" on-non-empty="true">
                                    if ((call_place.search == true)&amp;&amp;(call_place.id == 13)) {
                                    var o = new Object();
                                    o.id = station.id;
                                    o.name = station.name;
                                    o.addr = station.addr;
                                    o.addrname = station.addrname;
                                    o;
                                    } else if ((call_place.search == true)&amp;&amp;(call_place.id != 13))
                                    throw '!'
                                    else null
                                </ctrl:set-value-expression>
                            </ctrl:classifier>
                            <ctrl:hidden id="substation.id" default-value="#{dep.id?}"/>
                            <ctrl:hidden id="substation.name" default-value="#{dep.name?}"/>
                            <ctrl:hidden id="substation.addr" default-value="#{dep.addr?}"/>
                            <ctrl:hidden id="substation.addrname" default-value="#{dep.addrname?}"/>
                            <ctrl:classifier id="department" label="Подразделение" dependency-condition="(org.id != null)" css-class="ambcard-address-dep"
                                             search-as-you-type="true" autoselect-alone="true">
                                <ctrl:query query-id="ambdep" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="dorgId" ref="org.id"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                                <ctrl:set-value-expression on="call_place" on-load="false" on-non-empty="true">
                                    if ((call_place.search == true)&amp;&amp;(call_place.id == 13)) {
                                    var o = new Object();
                                    o.id = substation.id;
                                    o.name = substation.name;
                                    o.addr = substation.addr;
                                    o.addrname = substation.addrname;
                                    o;
                                    } else if ((call_place.search == true)&amp;&amp;(call_place.id != 13))
                                    throw '!'
                                    else null
                                </ctrl:set-value-expression>
                            </ctrl:classifier>
                        </fs:row>
                        <fs:row>
                            <ctrl:hidden id="addr_data.id" default-value="#{addr_parent?}"/>
                            <rc:address id="addr_data" label="Адрес вызова" css-class="ambcard-address-street">
                                <rc:set-value-expression on="org.id,department.id" on-load="false" on-non-empty="true" on-invisible="false">
                                    if ((typeof department != 'undefined') &amp;&amp;(department != null)  &amp;&amp;(department.addr != null)){
                                    var o = new Object();
                                    o.id = department.addr;
                                    o.displayName = department.addrname;
                                    o;
                                    } else if ((typeof org != 'undefined') &amp;&amp;(org != null)  &amp;&amp;(org.addr != null)) {
                                    var o = new Object();
                                    o.id = org.addr;
                                    o.displayName = org.addrname;
                                    o;
                                    } else throw '!';
                                </rc:set-value-expression>
                            </rc:address>
                        </fs:row>
                        <fs:row>
                            <ctrl:input-text id="addr_descr" label="Доп. ориентиры" css-class="ambcard-address-street">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="Addrcheck" side="client,server"/>
                                    <ctrl:validation ref-id="danger" side="client,server"/>
                                </ctrl:validations>
                            </ctrl:input-text>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="none" css-class="ambcard-fscaller">
                        <fs:row>
                            <ctrl:classifier id="caller" label="Вызвал" css-class="ambcard-phone ambcard-caller" copied="false" search-as-you-type="true">
                                <ctrl:query query-id="caller" value-field-id="id" label-field-id="name"/>
                                <ctrl:default-model>
                                    <ctrl:value field-id="id">22</ctrl:value>
                                    <ctrl:value field-id="name">сам(а)</ctrl:value>
                                </ctrl:default-model>
                            </ctrl:classifier>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="line" label="Вызов" css-class="ambcard-fsresult">
                        <fs:row>
                            <ctrl:classifier id="caller_reason" label="Повод" search-as-you-type="true"
                                             dependency-condition="(typeof call_kind == 'undefined') || (call_kind == null) || (call_kind.id != 3)&amp;&amp;(call_kind.id !=4)"
                                             required="true" css-class="ambcard-creason" copied="false">
                                <ctrl:query query-id="caller_reason" value-field-id="id" label-field-id="name"/>
                                <ctrl:validations>
                                    <ctrl:validation ref-id="upd_is_psycho_set" side="client"/>
                                    <ctrl:validation ref-id="upd_is_alco_set" side="client"/>
                                </ctrl:validations>
                            </ctrl:classifier>
                            <ctrl:classifier id="diagnosis" label="Диагноз(повод)" dependency-condition="(call_kind.id == 3)||(call_kind.id ==4)" required="true"
                                             css-class="ambcard-creason" copied="false" search-as-you-type="true">
                                <ctrl:query query-id="amb_diagnosis" value-field-id="id" label-field-id="name"/>
                                <ctrl:validations>
                                    <ctrl:validation ref-id="upd_is_psycho_set" side="client"/>
                                    <ctrl:validation ref-id="upd_is_alco_set" side="client"/>
                                </ctrl:validations>
                            </ctrl:classifier>
                            <ctrl:checkbox id="is_group" label="Гр." css-class="ambcard-is_group"/>
                            <ctrl:checkbox id="is_psycho" label="П" css-class="ambcard-is_group">
                                <ctrl:set-value-expression on="caller_reason,diagnosis" on-load="false">
                                    if (caller_reason.id != null) {
                                        if (caller_reason.is_psycho == true)
                                            true;
                                        else
                                            false;
                                    }
                                    else
                                        if (diagnosis.is_psycho == true)
                                            true;
                                        else
                                            false;
                                </ctrl:set-value-expression>
                            </ctrl:checkbox>
                            <ctrl:checkbox id="is_alco" label="А" css-class="ambcard-is_group"/>
                        </fs:row>
                        <fs:row>
                            <ctrl:classifier id="call_reason" label="Причина" css-class="ambcard-reason ambcard-label" search-as-you-type="true">
                                <ctrl:query query-id="call_reason" value-field-id="id" label-field-id="name"/>
                                <ctrl:set-value-expression on="caller_reason">
                                    if ((typeof caller_reason != 'undefined')&amp;&amp;(caller_reason != null)){
                                    var o = new Object();
                                    o.id = caller_reason.reason_id;
                                    o.name = caller_reason.reason_name;
                                    o;
                                    } else null;
                                </ctrl:set-value-expression>
                            </ctrl:classifier>
                        </fs:row>
                        <fs:row>
                            <ctrl:classifier id="reason_accident" label="Причина НС" css-class="ambcard-reason_accident ambcard-label"
                                             dependency-condition="call_reason.id == 1" search-as-you-type="true">
                                <ctrl:query query-id="reason_accident" value-field-id="id" label-field-id="name"/>
                                <ctrl:set-value-expression on="caller_reason.id">
                                    if ((typeof caller_reason != 'undefined')&amp;&amp;(caller_reason != null)){
                                    var o = new Object();
                                    o.id = caller_reason.accident_id;
                                    o.name = caller_reason.accident_name;
                                    o;
                                    } else null;
                                </ctrl:set-value-expression>
                            </ctrl:classifier>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="line" label="Диагноз" css-class="ambcard-fsresult">
                        <fs:row>
                            <ctrl:classifier id="master_diag" label="основной" css-class="ambcard-label ambcard-diagnosis" search-as-you-type="true" copied="false">
                                <ctrl:query query-id="amb_diagnosis" value-field-id="id" label-field-id="codename"/>
                                <ctrl:dependencies>
                                    <ctrl:required-condition>((step_result.code == '401')||(step_result.code == '402')||(step_result.code == '403')||(step_result.code == '404')||(step_result.code == '405')||(step_result.code == '406'))</ctrl:required-condition>
                                </ctrl:dependencies>
                                <ctrl:validations>
                                    <ctrl:validation ref-id="Diagcheck" side="client"/>
                                </ctrl:validations>
                            </ctrl:classifier>
                        </fs:row>
                        <ctrl:classifier id="master_injuryReason" label="Причина травмы" required="true" css-class="ambcard-label ambcard-diagnosis"
                                         search-are-you-type="true" dependency-condition="master_diag.injury == true">
                            <ctrl:query query-id="amb_injuryDiagnosis" label-field-id="name" value-field-id="id"/>
                            <ctrl:set-value-expression on="master_diag">
                                <![CDATA[ if(master_diag == null || master_diag.injury != true) null; else throw '!' ]]>
                            </ctrl:set-value-expression>
                        </ctrl:classifier>
                        <fs:row>
                            <ctrl:classifier id="take_birth" label="Роды приняты" css-class="ambcard-label ambcard-resource" search-as-you-type="true"
                                             dependency-condition="(master_diag.parent_code == 'O80')||(master_diag.parent_code == 'O81')||(master_diag.parent_code == 'O82')||(master_diag.parent_code == 'O83')||(master_diag.parent_code == 'O84')">
                                <ctrl:query query-id="take_birth" value-field-id="id" label-field-id="name"/>
                            </ctrl:classifier>
                        </fs:row>
                        <fs:row>
                            <ctrl:classifier id="accomp_diag" label="сопутствующий" css-class="ambcard-label ambcard-diagnosis" search-as-you-type="true" copied="false">
                                <ctrl:query query-id="amb_diagnosis" value-field-id="id" label-field-id="codename"/>
                            </ctrl:classifier>
                        </fs:row>
                        <fs:row>
                            <ctrl:classifier id="accomp_injuryReason" label="Причина травмы" required="true" css-class="ambcard-label ambcard-diagnosis"
                                             search-are-you-type="true" dependency-condition="accomp_diag.injury == true">
                                <ctrl:query query-id="amb_injuryDiagnosis" label-field-id="name" value-field-id="id"/>
                                <ctrl:set-value-expression on="accomp_diag">
                                    <![CDATA[ if(accomp_diag == null || accomp_diag.injury != true) null; else throw '!' ]]>
                                </ctrl:set-value-expression>
                            </ctrl:classifier>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="line" label="Результат" css-class="ambcard-fsresult">
                        <fs:row>
                            <ctrl:classifier id="step_result" label="Результат выезда" css-class="ambcard-result" required="true" copied="false" search-as-you-type="true">
                                <ctrl:query query-id="step_result" value-field-id="id" label-field-id="name"/>
                            </ctrl:classifier>
                            <ctrl:classifier id="care_result" label="Результат оказания МП" css-class="ambcard-outcome" required="true"
                                             dependency-condition="(step_result.code == '401')||(step_result.code == '402')||(step_result.code == '403')||(step_result.code == '404')"
                                             copied="false" search-as-you-type="true">
                                <ctrl:query query-id="step_care_result" value-field-id="id" label-field-id="codename">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="resId" ref="step_result.id"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                            </ctrl:classifier>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="line" css-class="ambcard-fsresult">
                            <fs:row>
                                <ctrl:classifier id="to_org" label="Госпитализирован в" css-class="ambcard-address-org"
                                                 dependency-condition="((step_result.code == '403')||(call_kind.id == 3)||(call_kind.id == 4))" copied="false" search-as-you-type="true">
                                    <ctrl:query query-id="amborg" value-field-id="id" label-field-id="name">
                                        <ctrl:pre-filters>
                                            <ctrl:pre-filter field-id="PRId" value="2"/>
                                        </ctrl:pre-filters>
                                    </ctrl:query>
                                    <ctrl:dependencies>
                                        <ctrl:required-condition>
                                            (step_result.code == '403')
                                        </ctrl:required-condition>
                                    </ctrl:dependencies>
                                </ctrl:classifier>
                                <ctrl:classifier id="to_department" label="Подразделение" css-class="ambcard-address-dep"
                                                 dependency-condition="((step_result.code == '403')||(call_kind.id == 3)||(call_kind.id == 4))" copied="false"
                                                 search-as-you-type="true" autoselect-alone="true">
                                    <ctrl:query query-id="ambdep" value-field-id="id" label-field-id="name">
                                        <ctrl:pre-filters>
                                            <ctrl:pre-filter field-id="org.id" ref="to_org.id"/>
                                        </ctrl:pre-filters>
                                    </ctrl:query>
                                </ctrl:classifier>
                            </fs:row>
                        </fs:field-set>
                        <fs:field-set header="line" dependency-condition="((step_result.code == '405')||(step_result.code == '406'))"  css-class="ambcard-fsresult">
                            <fs:row>
                                <ctrl:date-time id="death_date" label="Дата/время смерти" css-class="ambcard-death_date" copied="false"/>
                                <ctrl:masked-input id="death_time" label="" label-style="width:0;" css-class="ambcard-death_time" mask="99:99" copied="false">
                                    <ctrl:dependencies>
                                        <ctrl:required-condition>
                                            (step_result.code == '405') || (step_result.code == '406')
                                        </ctrl:required-condition>
                                    </ctrl:dependencies>
                                </ctrl:masked-input>
                                <ctrl:classifier id="deathemployee" label="Врач, констатировавший смерть" css-class="ambcard-death_employee" copied="false" search-as-you-type="true">
                                    <ctrl:query query-id="employee" value-field-id="id" label-field-id="namePos">
                                        <ctrl:pre-filters>
                                            <ctrl:pre-filter field-id="statId" value="#{org.id?}"/>
                                            <ctrl:pre-filter field-id="depId" value="#{dep.id?}"/>
                                        </ctrl:pre-filters>
                                    </ctrl:query>
                                </ctrl:classifier>
                            </fs:row>
                            <fs:row>
                                <ctrl:classifier id="death_diag" label="Посмертный диагноз" css-class="ambcard-label ambcard-individual" copied="false" search-as-you-type="true">
                                    <ctrl:query  query-id="amb_diagnosis" value-field-id="id" label-field-id="codename"/>
                                </ctrl:classifier>
                            </fs:row>
                            <fs:row>
                                <ctrl:text-area id="deathres" label="Причина смерти" rows="2" css-class="ambcard-label ambcard-note" copied="false"/>
                            </fs:row>
                    </fs:field-set>
                    <fs:field-set header="line" label="Информация по бригаде">
                        <fs:row>
                            <ctrl:classifier id="resDoc" label="Врач" css-class="ambcard-brg-res" search-as-you-type="true" autoselect-alone="true" copied="true">
                                <ctrl:query query-id="resource_one_job" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="resOrg" value="#{org.id?}"/>
                                        <ctrl:pre-filter field-id="res_kind.id" value="1"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                                <ctrl:validations>
                                    <ctrl:validation ref-id="checkResources" side="client,server"/>
                                </ctrl:validations>
                            </ctrl:classifier>
                            <ctrl:classifier id="res1" label="Фельдшер1" css-class="ambcard-brg-res" search-as-you-type="true" autoselect-alone="true" copied="true">
                                <ctrl:query query-id="resource_one_job" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="resOrg" value="#{org.id?}"/>
                                        <ctrl:pre-filter field-id="res_kind.id" value="1"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                            </ctrl:classifier>
                            <ctrl:classifier id="res2" label="Фельдшер2" css-class="ambcard-brg-res" search-as-you-type="true" autoselect-alone="true" copied="true">
                                <ctrl:query query-id="resource_one_job" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="resOrg" value="#{org.id?}"/>
                                        <ctrl:pre-filter field-id="res_kind.id" value="1"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                            </ctrl:classifier>
                        </fs:row>
                    </fs:field-set>
                </wgt:form>
            </container>
        </region>
    </regions>
</page>