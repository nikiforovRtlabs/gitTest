<?xml version='1.0' encoding='UTF-8'?>
<page xmlns="http://n2oapp.net/framework/config/schema/page-1.0"
      xmlns:ctrl="http://n2oapp.net/framework/config/schema/n2o-control-1.0"
      xmlns:wgt="http://n2oapp.net/framework/config/schema/n2o-widget-2.0"
      xmlns:fs="http://n2oapp.net/framework/config/schema/fieldset-2.0"
      xmlns:rc="http://atria.cz/app/config/schema/rmis-control-1.0">
    <!--<id>call</id>-->
    <name>Карта вызова (диспетчера)</name>
    <object-id>call</object-id>
    <layout>n2o/layout/top-bottom</layout>
    <regions>
        <region place="top" type="tabs">
            <container id="call" place="top" opened="true">
                <wgt:form src="ext/css/amb03-control-container-ambcard" customize="css" css-class="card-from amb-n2o-form">
                    <wgt:name>Карта вызова (диспетчера)</wgt:name>
                    <wgt:query-id>call</wgt:query-id>
                    <!--<wgt:edit after-submit="read">-->
                        <!--<wgt:invoke-action action-id="update"/>-->
                    <!--</wgt:edit>-->
                    <fs:field-set field-label-location="left" header="line" css-class="ambcard-first-block">
                        <fs:row>
                            <ctrl:output-text id="number" label="№" readonly="true"
                                              css-class="ambcard-number ambcard-boldtext"/>
                            <ctrl:classifier id="call_kind" label="Вид" readonly="true"
                                             dependency-condition="(typeof id != 'undefined') &amp;&amp; (id != null)"
                                             css-class="ambcard-kind">
                                <ctrl:query query-id="call_kind" value-field-id="id" label-field-id="code"/>
                            </ctrl:classifier>
                            <ctrl:classifier id="call_type" label="Тип" readonly="true" css-class="ambcard-type"
                                             dependency-condition="(typeof id != 'undefined') &amp;&amp; (id != null)">
                                <ctrl:query query-id="call_type" value-field-id="id" label-field-id="name"/>
                            </ctrl:classifier>

                            <ctrl:output-text id="priorNum" label="" readonly="true" css-class="ambcard-priorNum"/>
                            <ctrl:output-text id="employee.nameP" label="Принял"
                                              css-class="ambcard-remp ambcard-boldtext"/>
                            <ctrl:output-text id="change.data" readonly="true"
                                              css-class="ambcard-data ambcard-boldtext"/>
                            <ctrl:classifier id="desk" label="Пульт" dependency-condition="desk.id != null"
                                             css-class="ambcard-desk-upd ambcard-boldtext">
                                <ctrl:query query-id="desk" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="isValid" value="true"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                            </ctrl:classifier>
                        </fs:row>
                        <!--header="line" label="Исходный вызов"-->
                        <!--dependency-condition="(call_kind.id == 5)||(call_type.id == 2)||(call_type.id == 3)"-->
                        <fs:row>
                            <!--повторный вызов-->
                            <!--<ctrl:output-text id="date" label="Исходный вызов: Смена" dependency-condition="((call_type.id == 2)||(call_type.id == 3))"-->
                            <!--css-class="ambcard-parent_amb_data"/>-->
                            <ctrl:date-time id="date" label="Исходный вызов: Смена"
                                            dependency-condition="((call_type.id == 2)||(call_type.id == 3))"
                                            css-class="ambcard-parent_amb_data" default-value="today()"
                                            readonly="true"/>
                            <ctrl:input-text id="parent_call.num_change" label="№" css-class="ambcard-parent_amb_brg"
                                             dependency-condition="(call_type.id == 2)||(call_type.id == 3)"
                                             readonly="true"/>
                            <!--<ctrl:classifier id="parent_call" label="№" css-class="ambcard-parent_amb_brg" readonly="true"-->
                            <!--dependency-condition="(call_type.id == 2)||(call_type.id == 3)">-->
                            <!--<ctrl:query query-id="call" value-field-id="id" label-field-id="num_change"/>-->
                            <!--</ctrl:classifier>-->
                            <!--спц-->
                            <ctrl:classifier id="parbrg" label="Бригада" dependency-condition="(call_kind.id == 5)"
                                             css-class="ambcard-parent_amb_brg" readonly="true">
                                <ctrl:query query-id="ambbrg" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="station.id" value="#{org.id?}"/>
                                        <ctrl:pre-filter field-id="is_free" value="false"/>
                                        <ctrl:pre-filter field-id="is_edate" value="false"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                                <ctrl:validations>
                                    <!--<ctrl:validation ref-id="checkSPC"/>-->
                                </ctrl:validations>
                            </ctrl:classifier>
                            <ctrl:input-text id="parent_call.num_change" label="Вызов №"
                                             dependency-condition="(call_kind.id == 5)"
                                             css-class="ambcard-parent_amb_brg" readonly="true"/>
                            <!--<ctrl:classifier id="parent_call" label="Вызов №" dependency-condition="(call_kind.id == 5)" css-class="ambcard-parent_amb_brg" readonly="true">-->
                            <!--<ctrl:query query-id="call" value-field-id="id" label-field-id="num_change">-->
                            <!--<ctrl:pre-filters>-->
                            <!--<ctrl:pre-filter field-id="station" value="#{org.id?}"/>-->
                            <!--<ctrl:pre-filter field-id="change.fdata" ref="date"/>-->
                            <!--&lt;!&ndash;<ctrl:pre-filter field-id="substation" ref="#{dep.id?}"/>&ndash;&gt;-->
                            <!--<ctrl:pre-filter field-id="brg.id" ref="parbrg.id"/>-->
                            <!--</ctrl:pre-filters>-->
                            <!--</ctrl:query>-->
                            <!--</ctrl:classifier>-->
                        </fs:row>
                        <fs:row>
                            <!--амбулаторный-->
                            <ctrl:classifier id="brg" label="Бригада" dependency-condition="(call_kind.id == 7)"
                                             css-class="ambcard-parent_amb_brg" search-as-you-type="true">
                                <ctrl:query query-id="ambbrg" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="station.id" value="#{org.id?}"/>
                                        <ctrl:pre-filter field-id="is_free" value="true"/>
                                        <!--<ctrl:pre-filter field-id="change.id" value="#{change.id}"/>-->
                                        <ctrl:pre-filter field-id="is_edate" value="false"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                                <ctrl:validations>
                                    <!--<ctrl:validation ref-id="checkSPC"/>-->
                                </ctrl:validations>
                            </ctrl:classifier>
                            <ctrl:classifier id="emp" label="Сотрудник" dependency-condition="call_kind.id == 7"
                                             css-class="ambcard-parent_amb_emp"
                                             search-as-you-type="true">
                                <ctrl:query query-id="job_resource" value-field-id="id" label-field-id="res_name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="station.id" value="#{org.id?}"/>
                                        <!--<ctrl:pre-filter field-id="change.id" value="#{change.id}"/>-->
                                        <ctrl:pre-filter field-id="res_kind.id" value="1"/>
                                        <ctrl:pre-filter field-id="is_start" value="true"/>
                                        <ctrl:pre-filter field-id="is_edate" value="false"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                                <ctrl:validations>
                                    <ctrl:validation ref-id="checkAmb"/>
                                </ctrl:validations>
                            </ctrl:classifier>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="line" label="Время (часы, минуты)" css-class="ambcard-fstime_03">
                        <fs:row>
                            <ctrl:input-text id="from_time" label="Принят" readonly="true" css-class="ambcard-from_time"/>
                            <ctrl:input-text id="to_time" label="Завершен" readonly="true" css-class="ambcard-to_time"/>
                            <ctrl:input-text id="calltime" label="Длит-ть" readonly="true" css-class="ambcard-calltime"/>
                        </fs:row>
                        <fs:row>
                            <ctrl:input-text id="state_history.datetime" label="Время" readonly="true" css-class="ambcard-datetime"/>
                            <ctrl:input-text id="call_state.name" readonly="true" css-class="ambcard-call_state"/>
                            <!--контрольное время-->
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set field-label-location="left" css-class="ambcard-fsnotes_03">
                        <ctrl:output-text id="notes" readonly="true" label="" label-style="width:0;"/>
                    </fs:field-set>
                    <fs:field-set header="line" label="Вызов" css-class="ambcard-fscall">
                        <fs:row>
                            <ctrl:classifier id="caller_reason" label="Повод" search-as-you-type="true"
                                             css-class="ambcard-reason_03" required="true">
                                <ctrl:query query-id="caller_reason" value-field-id="id" label-field-id="name"/>
                                <ctrl:validations>
                                    <ctrl:validation ref-id="upd_is_psycho_set" side="client"/>
                                    <ctrl:validation ref-id="upd_is_psycho_rem" side="client"/>
                                    <ctrl:validation ref-id="upd_is_alco_set" side="client"/>
                                    <ctrl:validation ref-id="upd_is_alco_rem" side="client"/>
                                    <ctrl:validation ref-id="exists_call_answer" side="client"/>
                                </ctrl:validations>
                            </ctrl:classifier>
                            <ctrl:input-text id="callerReasonId" visible="false"/>
                            <ctrl:input-text id="reason_note" label="" css-class="ambcard-reason_note_03"/>
                            <ctrl:checkbox id="is_group" label="Гр." css-class="ambcard-is_group">
                                <!--<wgt:invoke-action action-id="changeGroup"/>-->
                            </ctrl:checkbox>
                            <ctrl:checkbox id="is_psycho" label="П" css-class="ambcard-is_group">
                                <ctrl:set-value-expression on="caller_reason,diagnosis" on-load="false">
                                    if (caller_reason.id != null) {
                                        if (caller_reason.is_psycho == true)
                                            true;
                                        else
                                            false;
                                    }
                                    else
                                        if (diagnosis.is_psycho == true)
                                            true;
                                        else
                                            false;
                                </ctrl:set-value-expression>
                            </ctrl:checkbox>
                            <ctrl:hidden id="is_psycho_field"/>
                            <ctrl:checkbox id="is_alco" label="А" css-class="ambcard-is_group"/>
                            <ctrl:hidden id="is_alco_field"/>
                        </fs:row>
                        <fs:row>
                            <ctrl:classifier id="diagnosis" label="Диагноз-повод" dependency-condition="(call_kind.id == 3)||(call_kind.id ==4)||(call_kind.id == 5)"
                                             css-class="ambcard-reason_03" required="true" search-as-you-type="true">
                                <ctrl:query query-id="amb_diagnosis" value-field-id="id" label-field-id="codename"/>
                                <ctrl:validations>
                                    <ctrl:validation ref-id="upd_is_psycho_set" side="client"/>
                                    <ctrl:validation ref-id="upd_is_psycho_rem" side="client"/>
                                    <ctrl:validation ref-id="upd_is_alco_set" side="client"/>
                                    <ctrl:validation ref-id="upd_is_alco_rem" side="client"/>
                                </ctrl:validations>
                            </ctrl:classifier>
                        </fs:row>
                        <fs:row>
                            <ctrl:input-text id="sum_sufferer" label="Количество пострадавших" dependency-condition="group == true"
                                             css-class="ambcard-sum_sufferer"/>
                        </fs:row>
                        <fs:row>
                            <ctrl:classifier id="call_place" label="Место вызова" css-class="ambcard-address" required="true"
                                             search-as-you-type="true" autoselect-alone="true">
                                <ctrl:query query-id="call_place" value-field-id="id" label-field-id="name"/>
                            </ctrl:classifier>
                            <ctrl:input-text id="place_note" label="" css-class="ambcard-address-note" label-style="width:0;"/>
                        </fs:row>
                        <fs:row>
                            <!--<ctrl:hidden id="station.name" default-value="#{org.name?}"/>-->
                            <!--<ctrl:hidden id="station.addr" default-value="#{org.addr}"/>-->
                            <!--<ctrl:output-text id="station.addrname"/>-->
                            <ctrl:classifier id="org" label="Организация" css-class="ambcard-address-org"
                                             search-as-you-type="true" dependency-condition="(call_place.search == true)">
                                <ctrl:query query-id="amborg" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="PRId" ref="call_place.PRId"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                                <ctrl:set-value-expression on="call_place.id" on-load="false" on-non-empty="true">
                                    if ((call_place.search == true)&amp;&amp;(call_place.id == 13)) {
                                    var o = new Object();
                                    o.id = station.id;
                                    o.name = station.name;
                                    o.addr = station.addr;
                                    o.addrname = station.addrname;
                                    o;
                                    } else if ((call_place.search == true)&amp;&amp;(call_place.id != 13))
                                    throw '!'
                                    else null
                                </ctrl:set-value-expression>
                            </ctrl:classifier>
                            <!--<ctrl:hidden id="substation.id" default-value="#{dep.id?}"/>-->
                            <!--<ctrl:hidden id="substation.name" default-value="#{dep.name?}"/>-->
                            <!--<ctrl:hidden id="substation.addr" default-value="#{dep.addr}"/>-->
                            <!--<ctrl:hidden id="substation.addrname" default-value="#{dep.addrname}"/>-->
                            <ctrl:hidden id="department">
                                <ctrl:set-value-expression on="org.id,call_place.id" on-load="false" on-non-empty="true">
                                    if ((call_place.search == true)&amp;&amp;(call_place.id == 13)) {
                                    var o = new Object();
                                    o.id = substation.id;
                                    o.name = substation.name;
                                    o.addr = substation.addr;
                                    o.addrname = substation.addrname;
                                    o;
                                    } else if ((call_place.search == true)&amp;&amp;(call_place.id != 13))
                                    throw '!'
                                    else null
                                </ctrl:set-value-expression>
                            </ctrl:hidden>

                            <ctrl:classifier id="department" label="Подразделение" dependency-condition="(call_place.search == true)"
                                             css-class="ambcard-address-dep" search-as-you-type="true" autoselect-alone="false">
                                <ctrl:query query-id="ambdep" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="dorgId" ref="org.id"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                                <ctrl:set-value-expression on="org.id" on-load="false" on-non-empty="false">
                                    if ((call_place.search != true)||(call_place.id != 13)) callQuery(); else throw '!'
                                </ctrl:set-value-expression>
                            </ctrl:classifier>

                        </fs:row>
                        <fs:row>
                            <!--RMISNNO-205 задача на set-value-expression и validation-->
                            <!--todo RMISNNO-206 задача на ограничения уровня отображения-->
                            <!--<ctrl:hidden id="addr_data">-->
                                <!--<ctrl:set-value-expression on="org.id,department.id" on-load="true" on-non-empty="true">-->
                                    <!--if ((typeof department != 'undefined') &amp;&amp;(department != null)  &amp;&amp;(department.addr != null)){-->
                                    <!--var o = new Object();-->
                                    <!--o.id = department.addr;-->
                                    <!--o.search_name = department.addrname;-->
                                    <!--o;-->
                                    <!--} else if ((typeof org != 'undefined') &amp;&amp;(org != null)  &amp;&amp;(org.addr != null)) {-->
                                    <!--var o = new Object();-->
                                    <!--o.id = org.addr;-->
                                    <!--o.search_name = org.addrname;-->
                                    <!--o;-->
                                    <!--} else throw '!'-->
                                <!--</ctrl:set-value-expression>-->
                            <!--</ctrl:hidden>-->

                            <!--todo HOTANALYTICS-2432 address_parent = ref-->
                            <rc:address id="addr_data" label="Адрес вызова" css-class="ambcard-address-street">
                                <rc:set-value-expression on="org.id,department.id" on-load="true" on-non-empty="true" on-invisible="false">
                                    if ((typeof department != 'undefined') &amp;&amp;(department != null)  &amp;&amp;(department.addr != null)){
                                    var o = new Object();
                                    o.id = department.addr;
                                    o.search_name = department.addrname;
                                    o;
                                    } else if ((typeof org != 'undefined') &amp;&amp;(org != null)  &amp;&amp;(org.addr != null)) {
                                    var o = new Object();
                                    o.id = org.addr;
                                    o.search_name = org.addrname;
                                    o;
                                    } else throw '!'
                                </rc:set-value-expression>
                            </rc:address>
                            <ctrl:input-text id="porch" label="Подъезд"/>
                            <ctrl:input-text id="floor" label="Этаж"/>
                            <ctrl:input-text id="door_code" label="Код домофона"/>
                        </fs:row>
                        <fs:row>
                            <ctrl:input-text id="addr_descr" label="Доп. ориентиры" css-class="ambcard-address-street">
                                <ctrl:validations>
                                    <ctrl:validation ref-id="checkAddr" side="client,server"/>
                                    <ctrl:validation ref-id="danger_upd" side="client,server"/>
                                </ctrl:validations>
                            </ctrl:input-text>
                            <!--<ctrl:input-text id="house" label="д." css-class="ambcard-address-house"/>-->
                            <!--<ctrl:input-text id="housing" label="кор." css-class="ambcard-address-numbers"/>-->
                            <!--<ctrl:input-text id="apartment" label="кв." css-class="ambcard-address-numbers"/>-->
                            <!--<ctrl:input-text id="porch" label="под." css-class="ambcard-address-numbers"/>-->
                            <!--<ctrl:input-text id="floor" label="эт." css-class="ambcard-address-numbers"/>-->
                            <!--<ctrl:input-text id="door_code" label="код" css-class="ambcard-address-numbers"/>-->
                            <!--<ctrl:input-text id="addr_descr" label="" css-class="ambcard-address-descr" label-style="width:0;">-->
                                <!--<ctrl:validations>-->
                                    <!--<ctrl:validation ref-id="checkAddr"/>-->
                                <!--</ctrl:validations>-->
                            <!--</ctrl:input-text>-->
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="none" label="Вызвал" css-class="ambcard-fscaller">
                        <fs:row>
                            <ctrl:classifier id="caller" label="Вызвал" css-class="ambcard-caller" search-as-you-type="true">
                                <ctrl:query query-id="caller" value-field-id="id" label-field-id="name"/>
                            </ctrl:classifier>
                            <ctrl:input-text id="caller_note" label="" label-style="width:0;">
                                <ctrl:set-value-expression on="caller,employee_med" on-load="false" on-non-empty="true">
                                    if ((typeof employee_med != 'undefined') &amp;&amp; (employee_med != null)&amp;&amp; (employee_med.id != null)) (caller.name+' '+employee_med.name); else caller.name
                                </ctrl:set-value-expression>
                            </ctrl:input-text>
                            <ctrl:masked-input id="phone" mask="8(999)999-99-99" default-value="8(843)___-__-__" css-class="ambcard-phone"/>
                        </fs:row>
                        <fs:row>
                            <ctrl:classifier id="employee_med" label="Сотрудник МО" dependency-condition="(org.id != null)||(caller.id == 6)"
                                             css-class="ambcard-label" search-as-you-type="true">
                                <ctrl:query query-id="employee" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="station.id" ref="org.id"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                            </ctrl:classifier>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="line" label="Пациент" field-label-location="left">
                        <fs:row>
                            <rc:patient id="individual" dependency-condition="is_offline" label="Пациент" control-style="width:675px;" label-style="width:100px;" isFilter="true">
                                <rc:update-model query-id="RegClinicCalculate" master-field-id="individual.id" detail-field-id="indiv" target-field-id="attachment.name" value-field-id="name" target="field"/>
                            </rc:patient>
                            <rc:patient id="individual" dependency-condition="!is_offline" label="Пациент" control-style="width:675px;" label-style="width:100px;">
                                <rc:update-model query-id="RegClinicCalculate" master-field-id="individual.id" detail-field-id="indiv" target-field-id="attachment.name" value-field-id="name" target="field"/>
                            </rc:patient>
                        </fs:row>
                        <fs:row>
                            <ctrl:input-text id="attachment.name" label="Прикреплен к" css-class="ambcard-label ambcard-individual" readonly="true"/>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="none" css-class="ambcard-fspatientfio" field-label-location="left" >
                        <fs:row>
                            <ctrl:input-text id="individual.surname" label="Фамилия" css-class="ambcard-label">
                                <!--<ctrl:set-value-expression>-->
                                    <!--if ((typeof individual != 'undefined')&amp;&amp;(individual != null)&amp;&amp;(individual.id != null)) individual.surname; else throw '!'-->
                                <!--</ctrl:set-value-expression>-->
                                <ctrl:dependencies>
                                    <ctrl:enabling-condition>
                                        (typeof individual == 'undefined') || (individual == null) || (individual.id == null) || (individual.can_modif == true)
                                    </ctrl:enabling-condition>
                                </ctrl:dependencies>
                            </ctrl:input-text>
                        </fs:row>
                        <fs:row>
                            <ctrl:input-text id="individual.name" label="Имя" css-class="ambcard-label">
                                <!--<ctrl:set-value-expression>-->
                                    <!--if ((typeof individual != 'undefined')&amp;&amp;(individual != null)&amp;&amp;(individual.id != null)) individual.name; else throw '!'-->
                                <!--</ctrl:set-value-expression>-->
                                <ctrl:dependencies>
                                    <ctrl:enabling-condition>
                                        (typeof individual == 'undefined') || (individual == null) || (individual.id == null) || (individual.can_modif == true)
                                    </ctrl:enabling-condition>
                                </ctrl:dependencies>
                            </ctrl:input-text>
                        </fs:row>
                        <fs:row>
                            <ctrl:input-text id="individual.patrName" label="Отчество" css-class="ambcard-label">
                                <!--<ctrl:set-value-expression>-->
                                    <!--if ((typeof individual != 'undefined')&amp;&amp;(individual != null)&amp;&amp;(individual.id != null)) individual.patrName; else throw '!'-->
                                <!--</ctrl:set-value-expression>-->
                                <ctrl:dependencies>
                                    <ctrl:enabling-condition>
                                        (typeof individual == 'undefined') || (individual == null) || (individual.id == null) || (individual.can_modif == true)
                                    </ctrl:enabling-condition>
                                </ctrl:dependencies>
                            </ctrl:input-text>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="none" label="" css-class="ambcard-fspatientage" field-label-location="left">
                        <!--<fs:field-set header="none" label="" css-class="ambcard-fspatientage" field-label-location="left" dependency-condition="(typeof individual != 'undefined') &amp;&amp; (individual != null)">-->
                        <fs:row>
                            <!--todo 2.4.1-->
                            <ctrl:hidden id="bd">
                                <ctrl:set-value-expression on="individual" on-load="true" on-non-empty="true" on-invisible="true">
                                    if ((typeof individual != 'undefined')&amp;&amp;(individual != null)&amp;&amp;(individual.id != null)) individual.birthDateWithAge; else null;
                                </ctrl:set-value-expression>
                            </ctrl:hidden>

                            <ctrl:date-time id="individual.birthDate" label="Дата рожд." css-class="ambcard-label ambcard-birth_dt">
                                <!--<ctrl:set-value-expression>-->
                                    <!--if ((typeof individual != 'undefined')&amp;&amp;(individual != null)&amp;&amp;(individual.id != null)) individual.birthday; else throw '!'-->
                                <!--</ctrl:set-value-expression>-->
                                <ctrl:set-value-expression on="bd" on-load="true" on-non-empty="true" on-invisible="true">
                                    <!--if ((typeof source.individual != 'undefined')&amp;&amp;(source.individual != null)&amp;&amp;(source.individual.id != null))-->
                                    if ((typeof bd != 'undefined')&amp;&amp;(bd != null))
                                        moment(bd.substring(0,10),'DD.MM.YYYY').format('DD.MM.YYYY HH:mm')
                                    ; else throw '!'
                                </ctrl:set-value-expression>
                                <ctrl:dependencies>
                                    <ctrl:enabling-condition>
                                        (typeof individual == 'undefined') || (individual == null) || (individual.id == null) || (individual.can_modif == true)
                                    </ctrl:enabling-condition>
                                </ctrl:dependencies>
                            </ctrl:date-time>
                            <ctrl:classifier id="gender" label="Пол" css-class="ambcard-gender">
                                <ctrl:query query-id="amb_gender" value-field-id="id" label-field-id="name"/>
                                <ctrl:set-value-expression on="individual" on-non-empty="true" on-readonly="true">
                                    <!-- если пациент вернулся с компонента -->
                                    if ((typeof individual != 'undefined')&amp;&amp;(individual != null)&amp;&amp;(individual.genderId != null)){
                                        var o = new Object();
                                        o.id = individual.genderId;
                                        o.name = individual.genderName;
                                        o;
                                    <!-- при удалении пациента через компонент -->
                                    } else if ((typeof individual == 'undefined')&amp;&amp;(individual == null)&amp;&amp;individual.genderId == null){
                                        null;
                                    <!-- при ручном вводе пациента -->
                                    } else if ((typeof individual != 'undefined')&amp;&amp;(individual != null)&amp;&amp;individual.genderId == null){
                                        var o = new Object();
                                        o.id = gender.id;
                                        o.name = gender.name;
                                        o;
                                    }
                                </ctrl:set-value-expression>
                                <ctrl:dependencies>
                                    <ctrl:enabling-condition>
                                        (typeof individual == 'undefined') || (individual == null) || (individual.id == null) || (individual.can_modif == true)
                                    </ctrl:enabling-condition>
                                </ctrl:dependencies>
                            </ctrl:classifier>
                        </fs:row>
                        <fs:row>
                            <ctrl:masked-input id="age_years" label="Возраст" css-class="ambcard-age-y">
                                <ctrl:set-value-expression on="individual.birthDate" on-load="false">
                                    <![CDATA[
                                    if ((typeof individual != 'undefined')&&(individual != null)&&(individual.birthDate != null)){
                                        var o = data;
                                        var yrs = moment(o, 'DD.MM.YYYY').diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'years');
                                        if ((yrs >= 1)) yrs;
                                        else null;
                                    } else null;
                                    ]]>
                                </ctrl:set-value-expression>
                            </ctrl:masked-input>
                            <ctrl:masked-input id="age_months" label="л." css-class="ambcard-age">
                                <ctrl:set-value-expression on="individual.birthDate" on-load="false">
                                    <![CDATA[
                                    if((typeof individual != 'undefined')&&(individual != null)&&(individual.birthDate != null)){
                                        var o = data;
                                        var mes = moment(o, 'DD.MM.YYYY').diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'months');
                                        var yrs = moment(o, 'DD.MM.YYYY').diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'years');

                                        if  ((yrs < 3) && (mes >= 1) && ((mes - yrs * 12) != 0)){
                                                if (mes > 11) {(mes - yrs * 12);
                                                } else {mes;}
                                        } else null;
                                    } else null;
                                    ]]>
                                </ctrl:set-value-expression>
                            </ctrl:masked-input>
                            <ctrl:masked-input id="age_days" label="мес." css-class="ambcard-age">
                                <ctrl:set-value-expression on="individual.birthDate" on-load="false">
                                    <![CDATA[
                                    if((typeof individual != 'undefined')&&(individual != null)&&(individual.birthDate != null)){
                                        var o = data;
                                        if  ((moment(o, 'DD.MM.YYYY').diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'years') < 1) &&
                                        (moment(o, 'DD.MM.YYYY').diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'months') < 1)
                                        ) moment(o, 'DD.MM.YYYY').diff(moment(individual.birthDate, 'DD.MM.YYYY'), 'days');
                                        else null;
                                    } else null;
                                    ]]>
                                </ctrl:set-value-expression>
                            </ctrl:masked-input>
                            <ctrl:output-text id="day" label="дн." css-class="ambcard-age"/>
                        </fs:row>
                    </fs:field-set>
                    <!--<fs:field-set header="line" label="Перевозка" dependency-condition="(call_kind.id == 3)||(call_kind.id ==4)" css-class="ambcard-fsaddress">-->
                    <fs:field-set header="line" label="Перевозка" dependency-condition="((call_kind.id == 3)||(call_kind.id ==4)||(has_hosp == true))" css-class="ambcard-fsaddress">
                        <fs:row>
                            <ctrl:classifier id="to_org" label="Организация" css-class="ambcard-address-org" search-as-you-type="true">
                                <ctrl:query query-id="amborg" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="PRId" value="2"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                            </ctrl:classifier>
                            <ctrl:classifier id="to_department" label="Подразделение" css-class="ambcard-address-dep"
                                             search-as-you-type="true" autoselect-alone="true">
                                <ctrl:query query-id="ambdep" value-field-id="id" label-field-id="name">
                                    <ctrl:pre-filters>
                                        <ctrl:pre-filter field-id="dorgId" ref="to_org.id"/>
                                    </ctrl:pre-filters>
                                </ctrl:query>
                            </ctrl:classifier>
                        </fs:row>
                        <fs:row>
                            <!--RMISNNO-205 задача на set-value-expression и validation-->
                            <!--todo RMISNNO-206 задача на ограничения уровня отображения-->
                            <!--<ctrl:hidden id="toaddr_data">-->
                                <!--dependency-condition="((call_kind.id == 3)||(call_kind.id == 4)||(step_result.code == '403')||(has_hosp == true))"-->
                                <!--<ctrl:set-value-expression on="to_org,to_department" on-load="false" on-non-empty="true">-->
                                    <!--if ((typeof to_department != 'undefined') &amp;&amp;(to_department != null)  &amp;&amp;(to_department.addr != null)){-->
                                    <!--var o = new Object();-->
                                    <!--o.id = to_department.addr;-->
                                    <!--o.displayName = to_department.addrname;-->
                                    <!--o;-->
                                    <!--} else if ((typeof to_org != 'undefined') &amp;&amp;(to_org != null)  &amp;&amp;(to_org.addr != null)) {-->
                                    <!--var o = new Object();-->
                                    <!--o.id = to_org.addr;-->
                                    <!--o.displayName = to_org.addrname;-->
                                    <!--o;-->
                                    <!--} else null;-->
                                <!--</ctrl:set-value-expression>-->
                            <!--</ctrl:hidden>-->
                            <!--todo HOTANALYTICS-2432 address_parent = ref-->
                            <rc:address id="toaddr_data" label="Адрес" css-class="ambcard-address-street">
                                <rc:set-value-expression on="to_org,to_department" on-load="false" on-non-empty="true" on-invisible="false">
                                    if ((typeof to_department != 'undefined') &amp;&amp;(to_department != null)  &amp;&amp;(to_department.addr != null)){
                                    var o = new Object();
                                    o.id = to_department.addr;
                                    o.displayName = to_department.addrname;
                                    o;
                                    } else if ((typeof to_org != 'undefined') &amp;&amp;(to_org != null)  &amp;&amp;(to_org.addr != null)) {
                                    var o = new Object();
                                    o.id = to_org.addr;
                                    o.displayName = to_org.addrname;
                                    o;
                                    } else null;
                                </rc:set-value-expression>
                            </rc:address>
                        </fs:row>
                        <fs:row>
                            <!--<ctrl:input-text id="to_house" label="д." css-class="ambcard-address-house"/>-->
                            <!--<ctrl:input-text id="to_housing" label="кор." css-class="ambcard-address-numbers"/>-->
                            <!--<ctrl:input-text id="to_apartment" label="кв." css-class="ambcard-address-numbers"/>-->
                            <!--<ctrl:input-text id="to_porch" label="под." css-class="ambcard-address-numbers"/>-->
                            <!--<ctrl:input-text id="to_addr_descr" label="" css-class="ambcard-address-to_descr" label-style="width:0;"/>-->
                            <ctrl:input-text id="to_addr_descr" label="Доп. ориентиры" css-class="ambcard-address-street"/>
                        </fs:row>
                    </fs:field-set>
                    <fs:field-set header="line" css-class="ambcard-fsresult">
                        <ctrl:text-area id="comment" label="Примечание" rows="2" css-class="ambcard-label ambcard-note"/>
                    </fs:field-set>
                    <wgt:action-menu>
                        <!--todo когда появиться доработка n2o: кнопка Enter - если разрешено редактирование, то действие update, иначе read-->
                        <!--убрано, чтоб открывался КТ на просмотр-->
                        <!--<wgt:menu-item id="update" label="Изменить (Enter)" context="true" default="true" key="Enter">-->
                            <!--<wgt:show-modal page-id="call" action-id="update" width="925px">                            -->
                            <!--<wgt:go-edit action-id="update"/>-->
                        <!--</wgt:menu-item>-->
                        <!--todo вырезание sub-menu, когда внутри нет ни одной кнопки-->
                        <wgt:menu-item id="notes" label="Отметки">
                            <wgt:sub-menu>
                                <wgt:menu-item id="citi1" label="Передача в службу (Alt+1)" key="Alt+1" context="true" default="false">
                                    <wgt:show-modal page-id="in_cityservice" container-id="top" master-field-id="id"
                                                    detail-field-id="call_id" width="715px" refresh-on-close="true"
                                                    page-name="Передача вызова №{call.number} в службы города">
                                        <wgt:pre-filters>
                                            <wgt:pre-filter field-id="call_note.type" value="true"/>
                                        </wgt:pre-filters>
                                    </wgt:show-modal>
                                    <wgt:conditions>
                                        <wgt:visibility-condition>
                                            <wgt:expression>(typeof id != 'undefined') &amp;&amp;(id != null) &amp;&amp;(has_note_city == true)</wgt:expression>
                                        </wgt:visibility-condition>
                                    </wgt:conditions>
                                </wgt:menu-item>
                                <wgt:menu-item id="citi2" label="Передача в службу (Alt+1)" key="Alt+1" context="true" default="false">
                                    <wgt:show-modal action-id="create" page-id="in_cityservice_ins"
                                                    container-id="single" master-field-id="id" detail-field-id="call_id"
                                                    width="715px" refresh-on-close="true"
                                                    page-name="Передача вызова №{call.number} в службы города"/>
                                    <wgt:conditions>
                                        <wgt:visibility-condition>
                                            <wgt:expression>(typeof id != 'undefined') &amp;&amp;(id != null) &amp;&amp;(has_note_city
                                                == false)
                                            </wgt:expression>
                                        </wgt:visibility-condition>
                                    </wgt:conditions>
                                </wgt:menu-item>
                                <wgt:menu-item id="selfrefused" label="Самоотказ(Alt+2)" key="Alt+2" context="true" default="false">
                                    <wgt:show-modal page-id="selfrefused" container-id="single" master-field-id="id"
                                                    detail-field-id="call_id" width="545px" refresh-on-close="true"
                                                    page-name="Самоотказ на вызове №{call.number}"/>
                                    <wgt:conditions>
                                        <wgt:visibility-condition>
                                            <wgt:expression>(typeof id != 'undefined') &amp;&amp;(id != null) </wgt:expression>
                                        </wgt:visibility-condition>
                                    </wgt:conditions>
                                </wgt:menu-item>
                                <wgt:menu-item id="doctor_refusal" label="Отказ врача(Alt+3)" key="Alt+3" context="true" default="false">
                                    <wgt:show-modal page-id="doctor_refusal" container-id="single" master-field-id="id"
                                                    detail-field-id="call_id" refresh-on-close="true" width="475px"
                                                    page-name="Отказ врача на вызове №{call.number}"/>
                                    <wgt:conditions>
                                        <wgt:visibility-condition>
                                            <wgt:expression>(typeof id != 'undefined') &amp;&amp;(id != null) </wgt:expression>
                                        </wgt:visibility-condition>
                                    </wgt:conditions>
                                </wgt:menu-item>
                                <wgt:menu-item id="hospitalization" label="Госпитализация(Alt+4)" key="Alt+4" context="true" default="false">
                                    <wgt:show-modal page-id="hospitalization" container-id="single" master-field-id="id"
                                                    detail-field-id="call_id" refresh-on-close="true" width="600px"
                                                    page-name="Госпитализация больного на вызове №{call.number}"/>
                                    <wgt:conditions>
                                        <wgt:visibility-condition>
                                            <wgt:expression>(typeof id != 'undefined') &amp;&amp;(id != null) </wgt:expression>
                                        </wgt:visibility-condition>
                                    </wgt:conditions>
                                </wgt:menu-item>
                                <wgt:menu-item id="double" label="Повторный/задвоенный(Alt+5)" default="false" key="Alt+5" context="true">
                                    <wgt:show-modal page-id="call_double" container-id="top" master-field-id="id"
                                                    detail-field-id="id" refresh-on-close="true" width="700px"
                                                    page-name="Повторность/Задвоенность вызова №{call.number}"/>
                                    <wgt:conditions>
                                        <wgt:visibility-condition>
                                            <wgt:expression>(typeof id != 'undefined') &amp;&amp;(id != null)</wgt:expression>
                                        </wgt:visibility-condition>
                                    </wgt:conditions>
                                    <!--todo баг n2o, как подправят проверить, убрав (жду 2.1.1)-->
                                    <wgt:properties>
                                        <wgt:property key="security-object" value="call_double"/>
                                    </wgt:properties>
                                </wgt:menu-item>
                            </wgt:sub-menu>
                        </wgt:menu-item>
                        <!--уберу, чтоб не мешало-->
                        <!--<wgt:menu-item id="history" label="История вызова (Alt+F12)" context="true" key="Alt+F12">-->
                            <!--<wgt:show-modal page-id="history" container-id="call" master-field-id="id" detail-field-id="id" width="850px"-->
                                            <!--page-name="История вызова №{call.number}"/>-->
                            <!--<wgt:conditions>-->
                                <!--<wgt:visibility-condition>-->
                                    <!--<wgt:expression>(typeof id != 'undefined') &amp;&amp;(id != null)</wgt:expression>-->
                                <!--</wgt:visibility-condition>-->
                            <!--</wgt:conditions>-->
                        <!--</wgt:menu-item>-->
                    </wgt:action-menu>
                    <!--<edit model="default"> <invoke-action action-id="create"/> </edit>-->
                    <!--<wgt:edit after-submit="read">-->
                        <!--<wgt:invoke-action action-id="create"/>-->
                    <!--</wgt:edit>-->
                </wgt:form>
            </container>
            <container id="call_double" place="bottom" depends-on="call" opened="true"
                       dependency-condition="((typeof call.mark == 'undefined') || (call.mark == null)||(call.mark == 0))">
                <!--dependency-condition="(mark != null)"-->
                <wgt:table master-field-id="id" detail-field-id="call_id">
                    <wgt:query-id>call_double</wgt:query-id>
                    <wgt:columns>
                        <wgt:column column-field-id="number" width="50px"/>
                        <wgt:column column-field-id="from_time" width="125px"/>
                        <wgt:column column-field-id="reas_diag" width="150px"/>
                        <wgt:column column-field-id="address" width="150px"/>
                        <wgt:column column-field-id="individual.indiv" width="150px"/>
                    </wgt:columns>
                    <wgt:action-menu>
                        <wgt:menu-item id="Repeat" label="Повторный(Alt+1)" context="true" key="Alt+1">
                            <wgt:invoke-action action-id="createRepeat" confirmation="false"/>
                            <wgt:conditions>
                                <wgt:enabling-condition>
                                    <wgt:expression>(note_type != true) &amp;&amp;(note_active !=true)</wgt:expression>
                                    <wgt:tooltip>Вызов уже имеет отметку о "Повторности/задвоенности"</wgt:tooltip>
                                </wgt:enabling-condition>
                                <wgt:visibility-condition>
                                    <wgt:expression>id != null</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>
                        <wgt:menu-item id="Double" label="Задвоенный(Alt+2)" context="true" key="Alt+2">
                            <wgt:invoke-action action-id="createRepeat" confirmation="false"/>
                            <wgt:conditions>
                                <wgt:enabling-condition>
                                    <wgt:expression>(note_type != true) &amp;&amp;(note_active !=true)</wgt:expression>
                                    <wgt:tooltip>Вызов уже имеет отметку о "Повторности/задвоенности"</wgt:tooltip>
                                </wgt:enabling-condition>
                                <wgt:visibility-condition>
                                    <wgt:expression>id != null</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="Repeatnull" label="2Повторный(Alt+1)" context="true" key="Alt+1">
                            <wgt:show-modal action-id="createRepeat" page-id="call_double_ins" width="500px"
                                            page-name="Вызов №{call_double.number} повторный"
                                    model="default">
                                <!--master-field-id="call_id" detail-field-id="call_id"-->
                                <wgt:pre-filters>
                                    <wgt:pre-filter field-id="call_id" ref="call_id"/>
                                </wgt:pre-filters>
                            </wgt:show-modal>
                            <wgt:conditions>
                                <wgt:enabling-condition>
                                    <wgt:expression>(note_type != true) &amp;&amp;(note_active !=true)</wgt:expression>
                                    <wgt:tooltip>Вызов уже имеет отметку о "Повторности/задвоенности"</wgt:tooltip>
                                </wgt:enabling-condition>
                                <wgt:visibility-condition>
                                    <wgt:expression>id == null</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>
                        <wgt:menu-item id="Doublenull" label="2Задвоенный(Alt+2)" context="true" key="Alt+2">
                            <wgt:show-modal action-id="createDouble" page-id="call_double_ins" master-field-id="call_id" detail-field-id="call_id" width="500px"
                                            page-name="Вызов №{call_double.number} задвоенный"/>
                            <wgt:conditions>
                                <wgt:enabling-condition>
                                    <wgt:expression>(note_type != true) &amp;&amp;(note_active !=true)</wgt:expression>
                                    <wgt:tooltip>Вызов уже имеет отметку о "Повторности/задвоенности"</wgt:tooltip>
                                </wgt:enabling-condition>
                                <wgt:visibility-condition>
                                    <wgt:expression>id == null</wgt:expression>
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>

                        <wgt:menu-item id="Primary" label="Первичный(Alt+3)" context="true" key="Alt+3">
                            <wgt:invoke-action action-id="createPrimarynote" confirmation="false"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>(note_type == true) &amp;&amp;(note_active ==true)</wgt:expression>
                                    <!--<wgt:tooltip>Вызов первичный</wgt:tooltip>-->
                                </wgt:visibility-condition>
                                <!--<wgt:enabling-condition>-->
                                <!--<!-<wgt:expression>has_note == true</wgt:expression>-->-->
                                <!--<wgt:expression>(note_type == true) &amp;&amp;(note_active ==true)</wgt:expression>-->
                                <!--<wgt:tooltip>Вызов первичный</wgt:tooltip>-->
                                <!--</wgt:enabling-condition>-->
                            </wgt:conditions>
                        </wgt:menu-item>
                        <wgt:menu-item id="Primarynull" label="Первичный(Alt+3)" context="true" key="Alt+3">
                            <wgt:invoke-action action-id="createPrimary" confirmation="false"/>
                            <wgt:conditions>
                                <wgt:visibility-condition>
                                    <wgt:expression>(has_note == false)</wgt:expression>
                                    <!--<wgt:expression>(has_note == false)&amp;&amp; (mark !== 1) </wgt:expression>-->
                                    <!--<wgt:expression>(note_type == true) &amp;&amp;(note_active ==true)</wgt:expression>-->
                                    <!--<wgt:tooltip>Вызов первичный</wgt:tooltip>-->
                                </wgt:visibility-condition>
                            </wgt:conditions>
                        </wgt:menu-item>
                    </wgt:action-menu>
                </wgt:table>
            </container>
        <container id="searchReason" depends-on="call">
            <wgt:form customize="js,jsp" src="ambulance/n2o/custom/searchReason/searchReason" detail-field-id="id" master-field-id="id">
                <wgt:name>Подбор повода</wgt:name>
                <wgt:query-id>call_temp</wgt:query-id>
            </wgt:form>
        </container>
        </region>
        <region place="bottom">

        </region>
    </regions>
</page>
